<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="kernel,scsi," />





  <link rel="alternate" href="/atom.xml" title="System Notes" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="&amp;#x7ECF;&amp;#x8FC7;&amp;#x524D;&amp;#x9762;&amp;#x7684;&amp;#x5206;&amp;#x6790;&amp;#x6D4B;&amp;#x8BD5;&amp;#xFF0C;&amp;#x4F7F;&amp;#x7528;fio&amp;#x76F4;&amp;#x63A5;&amp;#x6D4B;&amp;#x8BD5;&amp;#x88F8;&amp;#x76D8;&amp;#xFF08;direct=1&amp;#xFF09;&amp;#x7684;&amp;#x65F6;&amp;#x5019;&amp;#xFF">
<meta property="og:type" content="article">
<meta property="og:title" content="坏盘导致IO hang问题分析（续）">
<meta property="og:url" content="http://yoursite.com/2017/03/15/error-disk-cause-iohang2/index.html">
<meta property="og:site_name" content="System Notes">
<meta property="og:description" content="&amp;#x7ECF;&amp;#x8FC7;&amp;#x524D;&amp;#x9762;&amp;#x7684;&amp;#x5206;&amp;#x6790;&amp;#x6D4B;&amp;#x8BD5;&amp;#xFF0C;&amp;#x4F7F;&amp;#x7528;fio&amp;#x76F4;&amp;#x63A5;&amp;#x6D4B;&amp;#x8BD5;&amp;#x88F8;&amp;#x76D8;&amp;#xFF08;direct=1&amp;#xFF09;&amp;#x7684;&amp;#x65F6;&amp;#x5019;&amp;#xFF">
<meta property="og:image" content="http://yoursite.com/2017/03/15/error-disk-cause-iohang2/test_naked_TUR_packet.png">
<meta property="og:image" content="http://yoursite.com/2017/03/15/error-disk-cause-iohang2/test_fs_TUR_packet.png">
<meta property="og:updated_time" content="2017-03-15T08:25:51.886Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="坏盘导致IO hang问题分析（续）">
<meta name="twitter:description" content="&amp;#x7ECF;&amp;#x8FC7;&amp;#x524D;&amp;#x9762;&amp;#x7684;&amp;#x5206;&amp;#x6790;&amp;#x6D4B;&amp;#x8BD5;&amp;#xFF0C;&amp;#x4F7F;&amp;#x7528;fio&amp;#x76F4;&amp;#x63A5;&amp;#x6D4B;&amp;#x8BD5;&amp;#x88F8;&amp;#x76D8;&amp;#xFF08;direct=1&amp;#xFF09;&amp;#x7684;&amp;#x65F6;&amp;#x5019;&amp;#xFF">
<meta name="twitter:image" content="http://yoursite.com/2017/03/15/error-disk-cause-iohang2/test_naked_TUR_packet.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 坏盘导致IO hang问题分析（续） | System Notes </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?6958d5097bd406d16931b3fa137c6a9f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">System Notes</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                坏盘导致IO hang问题分析（续）
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-03-15T16:21:22+08:00" content="2017-03-15">
              2017-03-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index">
                    <span itemprop="name">storage</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/03/15/error-disk-cause-iohang2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/15/error-disk-cause-iohang2/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
              &nbsp; | &nbsp;
              <span class="page-pv"><i class="fa fa-file-o"></i>
              <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
              </span>
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>&#x7ECF;&#x8FC7;&#x524D;&#x9762;&#x7684;&#x5206;&#x6790;&#x6D4B;&#x8BD5;&#xFF0C;&#x4F7F;&#x7528;fio&#x76F4;&#x63A5;&#x6D4B;&#x8BD5;&#x88F8;&#x76D8;&#xFF08;direct=1&#xFF09;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C06;&#x540E;&#x7AEF;&#x8BBE;&#x5907;suspend&#x4F4F;&#x540E;&#xFF0C;fio&#x7684;IO hang&#x7684;&#x65F6;&#x95F4;&#x8DDF;&#x524D;&#x9762;&#x8BA1;&#x7B97;&#x7684;&#x4E00;&#x81F4;&#xFF1B;&#x4F46;&#x662F;&#x5F53;&#x5728;&#x865A;&#x62DF;&#x673A;&#x91CC;&#x5BF9;&#x8FD9;&#x5757;&#x76D8;&#x505A;&#x4E86;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF0C;&#x7136;&#x540E;fio&#x6D4B;&#x8BD5;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF08;direct=1&#xFF09;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C06;&#x540E;&#x7AEF;&#x8BBE;&#x5907;suspend&#x4F4F;&#x540E;&#xFF0C;fio&#x7684;IO hang&#x7684;&#x65F6;&#x95F4;&#x591A;&#x4E86;20~30s&#x3002;</p>
<h2 id="&#x521D;&#x6B65;&#x5206;&#x6790;"><a href="#&#x521D;&#x6B65;&#x5206;&#x6790;" class="headerlink" title="&#x521D;&#x6B65;&#x5206;&#x6790;"></a>&#x521D;&#x6B65;&#x5206;&#x6790;</h2><p>&#x4E00;&#x5F00;&#x59CB;&#x6000;&#x7591;&#x662F;&#x7531;&#x4E8E;&#x865A;&#x62DF;&#x673A;&#x8FD9;&#x5C42;&#x7684;&#x4F5C;&#x7528;&#xFF0C;&#x56E0;&#x6B64;&#x8FD8;&#x8C03;&#x6574;&#x8FC7;KVM&#x4F7F;&#x7528;&#x7684;&#x76D8;&#x7684;&#x7F13;&#x5B58;&#x7B56;&#x7565;&#xFF08;none&#x3001;writethrough&#x3001;directsync&#xFF09;&#xFF0C;&#x540C;&#x6837;&#x7684;&#x6D4B;&#x8BD5;&#xFF0C;&#x4ECD;&#x7136;&#x662F;IO hang&#x6BD4;&#x9884;&#x671F;&#x7684;&#x591A;20~30s&#x3002;</p>
<p>&#x6253;&#x5F00;iscsi session debug&#x5F00;&#x5173;&#xFF0C;&#x5F00;&#x542F;scsi error&#x548C;timeout&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x7136;&#x540E;&#x5206;&#x6790;&#x8FD9;&#x6837;&#x6D4B;&#x8BD5;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#x3002;&#x4E0B;&#x9762;&#x622A;&#x53D6;&#x90E8;&#x5206;&#x65E5;&#x5FD7;&#xFF0C;&#x53D1;&#x73B0;&#x6709;3&#x4E2A;&#x65F6;&#x95F4;&#x70B9;&#xFF1A;16:45:21&#x3001;16:45:31&#x3001;16:45:41&#x6BD4;&#x8F83;&#x5947;&#x602A;&#xFF0C;&#x6CA1;&#x6709;&#x8FDE;&#x7EED;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x90FD;&#x6709;10s&#x7684;&#x7A7A;&#x767D;&#x671F;&#x3002;&#x800C;&#x4E14;&#x4ECE;16:45:41&#x5230;16:45:51&#x540E;&#xFF0C;&#x5C31;&#x662F;&#x201D;Device offlined - not ready after error recovery&#x201D;&#xFF0C;&#x800C;&#x4E4B;&#x524D;&#x4ECE;&#x88F8;&#x76D8;&#x4E0A;&#x6D4B;&#x8BD5;&#x65F6;&#x662F;&#x6CA1;&#x6709;&#x8FD9;&#x51E0;&#x6B21;10s&#x7684;&#x7A7A;&#x767D;&#x671F;&#xFF0C;&#x800C;&#x4E14;&#x662F;I/O error&#xFF0C;&#x800C;&#x4E0D;&#x662F;device offlined&#x540E;&#x518D;I/O error&#x3002;<br><a id="more"></a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line">Feb  9 16:45:01 10-180-0-37 bash: HISTORY: PID=17516 UID=2010 sudo dmsetup suspend /dev/mapper/chunk_ebsdisk01_a551bcbe-a6c_1_1</span><br><span class="line">...........</span><br><span class="line">Feb  9 16:45:02 10-180-0-37 kernel: [3820717.924401]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e3dd21780 timedout</span><br><span class="line">Feb  9 16:45:02 10-180-0-37 kernel: [3820717.924415]  session50: iscsi_eh_cmd_timed_out return timer reset</span><br><span class="line">.......</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927424]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e3dd21780 timedout</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927434]  session50: iscsi_eh_cmd_timed_out return nh</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927437] Waking error handler thread</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927446] Error handler scsi_eh_50 waking up</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927620] sd 50:0:0:11: scsi_eh_prt_fail_stats: cmds failed: 0, cancel: 1</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927627] Total of 1 commands on 1 devices require eh work</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927629] scsi_eh_50: aborting cmd:0xffff881e3dd21780</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927632]  session50: iscsi_eh_abort aborting sc ffff881e3dd21780</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927635]  session50: iscsi_eh_abort aborting [sc ffff881e3dd21780 itt 0x35]</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927641]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927688] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927726]  session50: iscsi_eh_abort abort success [sc ffff881e3dd21780 itt 0x35]</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927784] scsi_eh_done scmd: ffff881e3dd21780 result: 0</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927791] scsi_send_eh_cmnd: scmd: ffff881e3dd21780, timeleft: 2500</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927793] scsi_send_eh_cmnd: scsi_eh_completed_normally 2002</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927796] scsi_eh_tur: scmd ffff881e3dd21780 rtn 2002</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927798] scsi_eh_50: flush retry cmd: ffff881e3dd21780</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.927963] scsi_restart_operations: waking up host to restart</span><br><span class="line">Feb  9 16:45:04 10-180-0-37 kernel: [3820719.928153] Error handler scsi_eh_50 sleeping</span><br><span class="line">.............</span><br><span class="line">Feb  9 16:45:06 10-180-0-37 kernel: [3820721.746537]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e3dd21780 timedout</span><br><span class="line">Feb  9 16:45:06 10-180-0-37 kernel: [3820721.746553]  session50: iscsi_eh_cmd_timed_out return timer reset</span><br><span class="line">...................</span><br><span class="line">Feb  9 16:45:08 10-180-0-37 kernel: [3820723.745561]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e3dd21780 timedout</span><br><span class="line">Feb  9 16:45:08 10-180-0-37 kernel: [3820723.745574]  session50: iscsi_eh_cmd_timed_out return nh</span><br><span class="line">Feb  9 16:45:08 10-180-0-37 kernel: [3820723.745577]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e57fee080 timedout</span><br><span class="line">Feb  9 16:45:08 10-180-0-37 kernel: [3820723.745585]  session50: iscsi_eh_cmd_timed_out return timer reset</span><br><span class="line">................</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744585]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e57fee080 timedout</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744598]  session50: iscsi_eh_cmd_timed_out return nh</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744602] Waking error handler thread</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744606] Error handler scsi_eh_50 waking up</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744785] sd 50:0:0:11: scsi_eh_prt_fail_stats: cmds failed: 0, cancel: 2</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744791] Total of 2 commands on 1 devices require eh work</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744793] scsi_eh_50: aborting cmd:0xffff881e3dd21780</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744796]  session50: iscsi_eh_abort aborting sc ffff881e3dd21780</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744799]  session50: iscsi_eh_abort aborting [sc ffff881e3dd21780 itt 0x2d]</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744806]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744855] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744902]  session50: iscsi_eh_abort abort success [sc ffff881e3dd21780 itt 0x2d]</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744904] scsi_eh_50: aborting cmd:0xffff881e57fee080</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744906]  session50: iscsi_eh_abort aborting sc ffff881e57fee080</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744908]  session50: iscsi_eh_abort aborting [sc ffff881e57fee080 itt 0x36]</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744916]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744936] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.744959]  session50: iscsi_eh_abort abort success [sc ffff881e57fee080 itt 0x36]</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.745033] scsi_eh_done scmd: ffff881e3dd21780 result: 0</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.745040] scsi_send_eh_cmnd: scmd: ffff881e3dd21780, timeleft: 2500</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.745042] scsi_send_eh_cmnd: scsi_eh_completed_normally 2002</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.745045] scsi_eh_tur: scmd ffff881e3dd21780 rtn 2002</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.745046] scsi_eh_50: flush retry cmd: ffff881e3dd21780</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.745054] scsi_eh_50: flush retry cmd: ffff881e57fee080</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.745214] scsi_restart_operations: waking up host to restart</span><br><span class="line">Feb  9 16:45:10 10-180-0-37 kernel: [3820725.745404] Error handler scsi_eh_50 sleeping</span><br><span class="line">Feb  9 16:45:11 10-180-0-37 kernel: [3820727.007961]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e57fee080 timedout</span><br><span class="line">Feb  9 16:45:11 10-180-0-37 kernel: [3820727.007978]  session50: iscsi_eh_cmd_timed_out return timer reset</span><br><span class="line">Feb  9 16:45:11 10-180-0-37 kernel: [3820727.007981]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e3dd21780 timedout</span><br><span class="line">Feb  9 16:45:11 10-180-0-37 kernel: [3820727.007984]  session50: iscsi_eh_cmd_timed_out return timer reset</span><br><span class="line">.................</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.006987]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e57fee080 timedout</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007000]  session50: iscsi_eh_cmd_timed_out return nh</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007004]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e3dd21780 timedout</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007006]  session50: iscsi_eh_cmd_timed_out return nh</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007010] Waking error handler thread</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007015] Error handler scsi_eh_50 waking up</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007194] sd 50:0:0:11: scsi_eh_prt_fail_stats: cmds failed: 0, cancel: 2</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007201] Total of 2 commands on 1 devices require eh work</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007203] scsi_eh_50: aborting cmd:0xffff881e57fee080</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007206]  session50: iscsi_eh_abort aborting sc ffff881e57fee080</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007208]  session50: iscsi_eh_abort aborting [sc ffff881e57fee080 itt 0x3a]</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007215]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007264] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007304]  session50: iscsi_eh_abort abort success [sc ffff881e57fee080 itt 0x3a]</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007306] scsi_eh_50: aborting cmd:0xffff881e3dd21780</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007308]  session50: iscsi_eh_abort aborting sc ffff881e3dd21780</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007310]  session50: iscsi_eh_abort aborting [sc ffff881e3dd21780 itt 0x40]</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007317]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007340] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007359]  session50: iscsi_eh_abort abort success [sc ffff881e3dd21780 itt 0x40]</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007428] scsi_eh_done scmd: ffff881e57fee080 result: 0</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007435] scsi_send_eh_cmnd: scmd: ffff881e57fee080, timeleft: 2500</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007437] scsi_send_eh_cmnd: scsi_eh_completed_normally 2002</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007440] scsi_eh_tur: scmd ffff881e57fee080 rtn 2002</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007442] scsi_eh_50: flush retry cmd: ffff881e57fee080</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007449] scsi_eh_50: flush retry cmd: ffff881e3dd21780</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007610] scsi_restart_operations: waking up host to restart</span><br><span class="line">Feb  9 16:45:13 10-180-0-37 kernel: [3820729.007801] Error handler scsi_eh_50 sleeping</span><br><span class="line">..............</span><br><span class="line">Feb  9 16:45:15 10-180-0-37 kernel: [3820730.982019]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e3dd21780 timedout</span><br><span class="line">Feb  9 16:45:15 10-180-0-37 kernel: [3820730.982037]  session50: iscsi_eh_cmd_timed_out return timer reset</span><br><span class="line">Feb  9 16:45:15 10-180-0-37 kernel: [3820730.982040]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e57fee080 timedout</span><br><span class="line">Feb  9 16:45:15 10-180-0-37 kernel: [3820730.982043]  session50: iscsi_eh_cmd_timed_out return timer reset</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981042]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e3dd21780 timedout</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981055]  session50: iscsi_eh_cmd_timed_out return nh</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981060]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e57fee080 timedout</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981062]  session50: iscsi_eh_cmd_timed_out return nh</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981066] Waking error handler thread</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981069] Error handler scsi_eh_50 waking up</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981246] sd 50:0:0:11: scsi_eh_prt_fail_stats: cmds failed: 0, cancel: 2</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981253] Total of 2 commands on 1 devices require eh work</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981255] scsi_eh_50: aborting cmd:0xffff881e3dd21780</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981258]  session50: iscsi_eh_abort aborting sc ffff881e3dd21780</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981260]  session50: iscsi_eh_abort aborting [sc ffff881e3dd21780 itt 0x3e]</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981267]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981322] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981365]  session50: iscsi_eh_abort abort success [sc ffff881e3dd21780 itt 0x3e]</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981368] scsi_eh_50: aborting cmd:0xffff881e57fee080</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981370]  session50: iscsi_eh_abort aborting sc ffff881e57fee080</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981373]  session50: iscsi_eh_abort aborting [sc ffff881e57fee080 itt 0x3b]</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981393]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981420] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981439]  session50: iscsi_eh_abort abort success [sc ffff881e57fee080 itt 0x3b]</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981510] scsi_eh_done scmd: ffff881e3dd21780 result: 0</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981520] scsi_send_eh_cmnd: scmd: ffff881e3dd21780, timeleft: 2500</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981523] scsi_send_eh_cmnd: scsi_eh_completed_normally 2002</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981526] scsi_eh_tur: scmd ffff881e3dd21780 rtn 2002</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981529] scsi_eh_50: flush retry cmd: ffff881e3dd21780</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981537] scsi_eh_50: flush retry cmd: ffff881e57fee080</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981702] scsi_restart_operations: waking up host to restart</span><br><span class="line">Feb  9 16:45:17 10-180-0-37 kernel: [3820732.981894] Error handler scsi_eh_50 sleeping</span><br><span class="line">...............</span><br><span class="line">Feb  9 16:45:19 10-180-0-37 kernel: [3820734.836136]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e57fee080 timedout</span><br><span class="line">Feb  9 16:45:19 10-180-0-37 kernel: [3820734.836155]  session50: iscsi_eh_cmd_timed_out return timer reset</span><br><span class="line">Feb  9 16:45:19 10-180-0-37 kernel: [3820734.836158]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e3dd21780 timedout</span><br><span class="line">Feb  9 16:45:19 10-180-0-37 kernel: [3820734.836160]  session50: iscsi_eh_cmd_timed_out return timer reset</span><br><span class="line">................</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835160]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e57fee080 timedout</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835174]  session50: iscsi_eh_cmd_timed_out return nh</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835178]  session50: iscsi_eh_cmd_timed_out scsi cmd ffff881e3dd21780 timedout</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835180]  session50: iscsi_eh_cmd_timed_out return nh</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835184] Waking error handler thread</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835188] Error handler scsi_eh_50 waking up</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835374] sd 50:0:0:11: scsi_eh_prt_fail_stats: cmds failed: 0, cancel: 2</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835381] Total of 2 commands on 1 devices require eh work</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835383] scsi_eh_50: aborting cmd:0xffff881e57fee080</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835386]  session50: iscsi_eh_abort aborting sc ffff881e57fee080</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835388]  session50: iscsi_eh_abort aborting [sc ffff881e57fee080 itt 0x47]</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835394]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835438] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835474]  session50: iscsi_eh_abort abort success [sc ffff881e57fee080 itt 0x47]</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835476] scsi_eh_50: aborting cmd:0xffff881e3dd21780</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835478]  session50: iscsi_eh_abort aborting sc ffff881e3dd21780</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835480]  session50: iscsi_eh_abort aborting [sc ffff881e3dd21780 itt 0x48]</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835484]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835501] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835520]  session50: iscsi_eh_abort abort success [sc ffff881e3dd21780 itt 0x48]</span><br><span class="line">.............&#x4ECE;&#x8FD9;&#x91CC;&#x5F00;&#x59CB;&#x5C31;&#x662F;&#x7B49;&#x4E86;&#x5DEE;&#x4E0D;&#x591A;10s&#xFF0C;&#x7136;&#x540E;&#x6267;&#x884C;&#x4E86;&#x4E0B;&#x9762;&#x7684;&#x903B;&#x8F91;</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830267] scsi_send_eh_cmnd: scmd: ffff881e57fee080, timeleft: 0</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830274]  session50: iscsi_eh_abort aborting sc ffff881e57fee080</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830277]  session50: iscsi_eh_abort aborting [sc ffff881e57fee080 itt 0x42]</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830283]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830325] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830364] scsi_eh_done scmd: ffff881e57fee080 result: 50000</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830367]  session50: iscsi_eh_abort abort success [sc ffff881e57fee080 itt 0x42]</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830371] scsi_eh_tur: scmd ffff881e57fee080 rtn 2003</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830696] scsi_eh_50: Sending BDR sdev: 0xffff88329ad78800</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830698]  session50: iscsi_eh_device_reset LU Reset [sc ffff881e57fee080 lun 11]</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830702]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830728] iscsi_trgt: Logical Unit Reset (05) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830754]  session50: iscsi_eh_device_reset dev reset result = SUCCESS</span><br><span class="line">..........&#x53C8;&#x7B49;10s</span><br><span class="line">Feb  9 16:45:41 10-180-0-37 kernel: [3820756.825380] scsi_send_eh_cmnd: scmd: ffff881e57fee080, timeleft: 0</span><br><span class="line">Feb  9 16:45:41 10-180-0-37 kernel: [3820756.825387]  session50: iscsi_eh_abort aborting sc ffff881e57fee080</span><br><span class="line">Feb  9 16:45:41 10-180-0-37 kernel: [3820756.825390]  session50: iscsi_eh_abort aborting [sc ffff881e57fee080 itt 0x4e]</span><br><span class="line">Feb  9 16:45:41 10-180-0-37 kernel: [3820756.825397]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:41 10-180-0-37 kernel: [3820756.825441] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:41 10-180-0-37 kernel: [3820756.825475] scsi_eh_done scmd: ffff881e57fee080 result: 50000</span><br><span class="line">Feb  9 16:45:41 10-180-0-37 kernel: [3820756.825479]  session50: iscsi_eh_abort abort success [sc ffff881e57fee080 itt 0x4e]</span><br><span class="line">Feb  9 16:45:41 10-180-0-37 kernel: [3820756.825482] scsi_eh_tur: scmd ffff881e57fee080 rtn 2003</span><br><span class="line">Feb  9 16:45:41 10-180-0-37 kernel: [3820756.825497] scsi_eh_50: Sending target reset to target 0</span><br><span class="line">Feb  9 16:45:41 10-180-0-37 kernel: [3820756.825500]  session50: iscsi_eh_target_reset tgt Reset [sc ffff881e57fee080 tgt iqn.com.netease:ebsdisk01.8.0.0]</span><br><span class="line">Feb  9 16:45:41 10-180-0-37 kernel: [3820756.825504]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:41 10-180-0-37 kernel: [3820756.825534] iscsi_trgt: Target Warm Reset (06) issued on tid:2000 lun:0 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:41 10-180-0-37 kernel: [3820756.825561]  session50: iscsi_eh_target_reset tgt iqn.com.netease:ebsdisk01.8.0.0 reset result = SUCCESS</span><br><span class="line">.............&#x518D;&#x7B49;10s&#xFF0C;&#x7136;&#x540E;&#x4ECE;&#x4E0B;&#x9762;&#x7684;&#x65E5;&#x5FD7;&#x6765;&#x770B;&#x662F;Device offlined&#x540E;&#x518D;&#x51FA;&#x73B0;I/O error&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x5148;&#x51FA;&#x73B0;I/O error&#x518D;Device offlined&#xFF0C;&#x8FD9;&#x91CC;&#x6BD4;&#x8F83;&#x5947;&#x602A;</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820489] scsi_send_eh_cmnd: scmd: ffff881e57fee080, timeleft: 0</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820495]  session50: iscsi_eh_abort aborting sc ffff881e57fee080</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820498]  session50: iscsi_eh_abort aborting [sc ffff881e57fee080 itt 0x55]</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820504]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820546] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820584] scsi_eh_done scmd: ffff881e57fee080 result: 50000</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820587]  session50: iscsi_eh_abort abort success [sc ffff881e57fee080 itt 0x55]</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820590] scsi_eh_tur: scmd ffff881e57fee080 rtn 2003</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820593] scsi_eh_50: Sending BRST chan: 0</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820594] scsi_try_bus_reset: Snd Bus RST</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820596] scsi_eh_50: BRST failed chan: 0</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820597] scsi_eh_50: Sending HRST</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820599] scsi_try_host_reset: Snd Host RST</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820600] scsi_eh_50: HRST failed</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820603] sd 50:0:0:11: Device offlined - not ready after error recovery</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820606] sd 50:0:0:11: Device offlined - not ready after error recovery</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820607] scsi_eh_50: flush finish cmd: ffff881e57fee080</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820617] sd 50:0:0:11: [sdat] Unhandled error code</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820619] sd 50:0:0:11: [sdat]</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820621] Result: hostbyte=DID_ABORT driverbyte=DRIVER_OK</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820623] sd 50:0:0:11: [sdat] CDB:</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820625] Write(10): 2a 00 00 85 31 80 00 00 10 00</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.820633] end_request: I/O error, dev sdat, sector 8728960</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.827377] md/raid1:md388713: Disk failure on sdat, disabling device.</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.827377] md/raid1:md388713: Operation continuing on 1 devices.</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.827381] scsi_eh_50: flush finish cmd: ffff881e3dd21780</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.827386] sd 50:0:0:11: [sdat] Unhandled error code</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.827387] sd 50:0:0:11: [sdat]</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.827388] Result: hostbyte=DID_ABORT driverbyte=DRIVER_OK</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.827389] sd 50:0:0:11: [sdat] CDB:</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.827393] Write(10): 2a 00 00 0f 42 80 00 00 80 00</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.827394] end_request: I/O error, dev sdat, sector 1000064</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.827570] scsi_restart_operations: waking up host to restart</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.827760] Error handler scsi_eh_50 sleeping</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.848214] RAID1 conf printout:</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.848217]  --- wd:1 rd:2</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.848220]  disk 0, wo:0, o:1, dev:sdv</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.848221]  disk 1, wo:1, o:0, dev:sdat</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.881950] RAID1 conf printout:</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.881953]  --- wd:1 rd:2</span><br><span class="line">Feb  9 16:45:51 10-180-0-37 kernel: [3820766.881956]  disk 0, wo:0, o:1, dev:sdv</span><br></pre></td></tr></table></figure></p>
<p>&#x53E6;&#x5916;&#x4ECE;scsi cmd&#x7684;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#x6765;&#x770B;&#xFF0C;&#x8D85;&#x65F6;&#x91CD;&#x8BD5;&#x5904;&#x7406;&#x7684;&#x6709;2&#x4E2A;&#x8BF7;&#x6C42;&#xFF08;&#x4E00;&#x4E2A;&#x662F;lba=1000064 txlen=128&#x7684;&#xFF0C;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x662F;lba=912384 txlen=128&#x7684;&#x8BF7;&#x6C42;&#xFF09;&#xFF0C;&#x5E76;&#x4E14;&#x4ECE;&#x91CD;&#x8BD5;&#x6B21;&#x6570;&#x4E0A;&#x6765;&#x770B;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x5B8C;&#x5168;&#x8D70;&#x5B8C;5&#x6B21;&#x91CD;&#x8BD5;&#xFF0C;&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x65E5;&#x5FD7;&#x6765;&#x770B;&#x5E94;&#x8BE5;&#x662F;device offlined&#x540E;&#x5C31;&#x6CA1;&#x6709;&#x7EE7;&#x7EED;&#x91CD;&#x8BD5;&#x4E86;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">        &lt;...&gt;-68191 [024] .... 3820716.789544: scsi_dispatch_cmd_start: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=912384 txlen=128 protect=0 raw=2a 00 00 0d ec 00 00 00 80 00)</span><br><span class="line">        &lt;...&gt;-68375 [020] .... 3820716.814538: scsi_dispatch_cmd_start: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00)</span><br><span class="line">       &lt;idle&gt;-0     [012] d.s. 3820717.924396: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00) result=(driver=DRIVER_OK host=DID_OK message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">       &lt;idle&gt;-0     [012] dNs. 3820719.927417: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00) result=(driver=DRIVER_OK host=DID_TIME_OUT message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">kworker/27:1H-799   [027] .... 3820719.931530: scsi_dispatch_cmd_start: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00)</span><br><span class="line">       &lt;idle&gt;-0     [027] dNs. 3820721.746530: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00) result=(driver=DRIVER_OK host=DID_OK message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">        &lt;...&gt;-68191 [024] .... 3820721.896068: scsi_dispatch_cmd_start: host_no=50 channel=0 id=0 lun=11 data_sgl=2 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=8728960 txlen=16 protect=0 raw=2a 00 00 85 31 80 00 00 10 00)</span><br><span class="line">       &lt;idle&gt;-0     [027] dNs. 3820723.745553: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00) result=(driver=DRIVER_OK host=DID_TIME_OUT message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">       &lt;idle&gt;-0     [027] dNs. 3820723.745577: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=2 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=8728960 txlen=16 protect=0 raw=2a 00 00 85 31 80 00 00 10 00) result=(driver=DRIVER_OK host=DID_OK message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">       &lt;idle&gt;-0     [027] dNs. 3820725.744576: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=2 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=8728960 txlen=16 protect=0 raw=2a 00 00 85 31 80 00 00 10 00) result=(driver=DRIVER_OK host=DID_TIME_OUT message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line"> kworker/5:1H-801   [005] .... 3820725.748667: scsi_dispatch_cmd_start: host_no=50 channel=0 id=0 lun=11 data_sgl=2 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=8728960 txlen=16 protect=0 raw=2a 00 00 85 31 80 00 00 10 00)</span><br><span class="line"> kworker/5:1H-801   [005] .... 3820725.748672: scsi_dispatch_cmd_start: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00)</span><br><span class="line">       &lt;idle&gt;-0     [005] dNs. 3820727.007955: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=2 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=8728960 txlen=16 protect=0 raw=2a 00 00 85 31 80 00 00 10 00) result=(driver=DRIVER_OK host=DID_OK message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">       &lt;idle&gt;-0     [005] dNs. 3820727.007980: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00) result=(driver=DRIVER_OK host=DID_OK message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">       &lt;idle&gt;-0     [005] dNs. 3820729.006980: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=2 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=8728960 txlen=16 protect=0 raw=2a 00 00 85 31 80 00 00 10 00) result=(driver=DRIVER_OK host=DID_TIME_OUT message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">       &lt;idle&gt;-0     [005] dNs. 3820729.007003: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00) result=(driver=DRIVER_OK host=DID_TIME_OUT message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line"> kworker/7:1H-1265  [007] .... 3820729.011093: scsi_dispatch_cmd_start: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00)</span><br><span class="line"> kworker/7:1H-1265  [007] .... 3820729.011097: scsi_dispatch_cmd_start: host_no=50 channel=0 id=0 lun=11 data_sgl=2 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=8728960 txlen=16 protect=0 raw=2a 00 00 85 31 80 00 00 10 00)</span><br><span class="line">        &lt;...&gt;-72525 [007] d.s. 3820730.982012: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00) result=(driver=DRIVER_OK host=DID_OK message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">        &lt;...&gt;-72525 [007] d.s. 3820730.982039: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=2 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=8728960 txlen=16 protect=0 raw=2a 00 00 85 31 80 00 00 10 00) result=(driver=DRIVER_OK host=DID_OK message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">        &lt;...&gt;-108306 [007] d.s. 3820732.981033: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00) result=(driver=DRIVER_OK host=DID_TIME_OUT message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">        &lt;...&gt;-108306 [007] d.s. 3820732.981059: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=2 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=8728960 txlen=16 protect=0 raw=2a 00 00 85 31 80 00 00 10 00) result=(driver=DRIVER_OK host=DID_TIME_OUT message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">kworker/19:1H-2058  [019] .... 3820732.985038: scsi_dispatch_cmd_start: host_no=50 channel=0 id=0 lun=11 data_sgl=2 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=8728960 txlen=16 protect=0 raw=2a 00 00 85 31 80 00 00 10 00)</span><br><span class="line">kworker/19:1H-2058  [019] .... 3820732.985044: scsi_dispatch_cmd_start: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00)</span><br><span class="line">       &lt;idle&gt;-0     [019] dNs. 3820734.836127: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=2 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=8728960 txlen=16 protect=0 raw=2a 00 00 85 31 80 00 00 10 00) result=(driver=DRIVER_OK host=DID_OK message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">       &lt;idle&gt;-0     [019] dNs. 3820734.836157: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00) result=(driver=DRIVER_OK host=DID_OK message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">       &lt;idle&gt;-0     [019] dNs. 3820736.835151: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=2 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=8728960 txlen=16 protect=0 raw=2a 00 00 85 31 80 00 00 10 00) result=(driver=DRIVER_OK host=DID_TIME_OUT message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br><span class="line">       &lt;idle&gt;-0     [019] dNs. 3820736.835177: scsi_dispatch_cmd_timeout: host_no=50 channel=0 id=0 lun=11 data_sgl=16 prot_sgl=0 prot_op=SCSI_PROT_NORMAL cmnd=(WRITE_10 lba=1000064 txlen=128 protect=0 raw=2a 00 00 0f 42 80 00 00 80 00) result=(driver=DRIVER_OK host=DID_TIME_OUT message=COMMAND_COMPLETE status=SAM_STAT_GOOD)</span><br></pre></td></tr></table></figure></p>
<h2 id="&#x591A;3&#x6B21;10s&#x7684;&#x5206;&#x6790;"><a href="#&#x591A;3&#x6B21;10s&#x7684;&#x5206;&#x6790;" class="headerlink" title="&#x591A;3&#x6B21;10s&#x7684;&#x5206;&#x6790;"></a>&#x591A;3&#x6B21;10s&#x7684;&#x5206;&#x6790;</h2><p>&#x65E2;&#x7136;&#x65E5;&#x5FD7;&#x5206;&#x6790;&#x6765;&#x770B;&#x6CA1;&#x6709;&#x5B8C;&#x6210;&#x6807;&#x51C6;&#x7684;5&#x6B21;&#x8D85;&#x65F6;&#x91CD;&#x8BD5;&#xFF0C;&#x90A3;&#x8BF4;&#x660E;&#x5728;&#x4E2D;&#x95F4;&#x67D0;&#x4E2A;&#x9636;&#x6BB5;&#x8FDB;&#x5165;&#x5230;&#x5176;&#x4ED6;&#x6D41;&#x7A0B;&#x5BFC;&#x81F4;&#x591A;&#x4E86;3&#x6B21;10s&#x7684;&#x8D85;&#x65F6;&#x3002;&#x4E3A;&#x4E86;&#x5206;&#x6790;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#x5230;&#x5E95;&#x53D1;&#x751F;&#x4E86;&#x4EC0;&#x4E48;&#xFF0C;&#x5C31;&#x53EA;&#x80FD;&#x901A;&#x8FC7;&#x9605;&#x8BFB;linux&#x5185;&#x6838;&#x91CC;scsi error handle&#x8FD9;&#x90E8;&#x5206;&#x4EE3;&#x7801;&#xFF0C;&#x6839;&#x636E;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#x6765;&#x8FDB;&#x884C;&#x5206;&#x6790;&#xFF0C;&#x5E76;&#x4E14;&#x5BF9;&#x6BD4;&#x88F8;&#x76D8;fio&#x6D4B;&#x8BD5;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#x53D1;&#x73B0;&#xFF1A;&#x4ECE;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;fio&#x6D4B;&#x8BD5;&#x65F6;IO hang&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x65E5;&#x5FD7;&#x91CC;&#xFF0C;&#x67D0;&#x4E00;&#x6B21;iscsi abort success&#x540E;&#x5C31;&#x7B49;&#x4E86;10s&#xFF0C;&#x800C;&#x88F8;&#x76D8;&#x6D4B;&#x8BD5;&#x65F6;&#x662F;iscsi abort success&#x540E;&#x7D27;&#x8DDF;&#x7740;scsi_eh_done&#x51FD;&#x6570;&#x7684;&#x8C03;&#x7528;&#xFF0C;&#x8BF4;&#x660E;&#x95EE;&#x9898;&#x6709;&#x53EF;&#x80FD;&#x51FA;&#x5728;&#x8FD9;&#x91CC;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">**&#x4ECE;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;fio&#x6D4B;&#x8BD5;&#x65F6;&#x7684;&#x65E5;&#x5FD7;**</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835478]  session50: iscsi_eh_abort aborting sc ffff881e3dd21780</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835480]  session50: iscsi_eh_abort aborting [sc ffff881e3dd21780 itt 0x48]</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835484]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835501] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:7881300190757376 (Function Complete)</span><br><span class="line">Feb  9 16:45:21 10-180-0-37 kernel: [3820736.835520]  session50: iscsi_eh_abort abort success [sc ffff881e3dd21780 itt 0x48]</span><br><span class="line">.............&#x4ECE;&#x8FD9;&#x91CC;&#x5F00;&#x59CB;&#x5C31;&#x662F;&#x7B49;&#x4E86;&#x5DEE;&#x4E0D;&#x591A;10s</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830267] scsi_send_eh_cmnd: scmd: ffff881e57fee080, timeleft: 0</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830274]  session50: iscsi_eh_abort aborting sc ffff881e57fee080</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830277]  session50: iscsi_eh_abort aborting [sc ffff881e57fee080 itt 0x42]</span><br><span class="line">Feb  9 16:45:31 10-180-0-37 kernel: [3820746.830283]  session50: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line"></span><br><span class="line">**&#x88F8;&#x76D8;fio&#x6D4B;&#x8BD5;&#x65F6;&#x7684;&#x65E5;&#x5FD7;**</span><br><span class="line">Feb 10 09:49:33 10-180-0-37 kernel: [3882158.817537]  session52: iscsi_eh_abort aborting sc ffff884d6f25c180</span><br><span class="line">Feb 10 09:49:33 10-180-0-37 kernel: [3882158.817539]  session52: iscsi_eh_abort aborting [sc ffff884d6f25c180 itt 0x23]</span><br><span class="line">Feb 10 09:49:33 10-180-0-37 kernel: [3882158.817544]  session52: iscsi_exec_task_mgmt_fn tmf set timeout</span><br><span class="line">Feb 10 09:49:33 10-180-0-37 kernel: [3882158.817584] iscsi_trgt: Abort Task (01) issued on tid:2000 lun:11 by sid:9007200131154432 (Function Complete)</span><br><span class="line">Feb 10 09:49:33 10-180-0-37 kernel: [3882158.817616]  session52: iscsi_eh_abort abort success [sc ffff884d6f25c180 itt 0x23]</span><br><span class="line">..........&#x8FD9;&#x91CC;&#x662F;&#x7D27;&#x63A5;&#x7740;&#x8C03;&#x7528;&#x4E86;scsi_eh_done&#x51FD;&#x6570;</span><br><span class="line">Feb 10 09:49:33 10-180-0-37 kernel: [3882158.817669] scsi_eh_done scmd: ffff884d6f25c180 result: 0</span><br><span class="line">Feb 10 09:49:33 10-180-0-37 kernel: [3882158.817674] scsi_send_eh_cmnd: scmd: ffff884d6f25c180, timeleft: 2500</span><br><span class="line">Feb 10 09:49:33 10-180-0-37 kernel: [3882158.817676] scsi_send_eh_cmnd: scsi_eh_completed_normally 2002</span><br><span class="line">Feb 10 09:49:33 10-180-0-37 kernel: [3882158.817679] scsi_eh_tur: scmd ffff884d6f25c180 rtn 2002</span><br><span class="line">Feb 10 09:49:33 10-180-0-37 kernel: [3882158.817681] scsi_eh_52: flush finish cmd: ffff884d6f25c180</span><br></pre></td></tr></table></figure></p>
<p>&#x5E76;&#x4E14;&#x627E;&#x5230;&#x8FD9;10s&#x7B49;&#x5F85;&#x524D;&#x540E;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x53D1;&#x73B0;&#x6253;&#x5370;&#x4E86;&#x4E00;&#x53E5;&#x201D;scsi_send_eh_cmnd: scmd: ffff881e57fee080, timeleft: 0&#x201D;&#xFF0C;&#x627E;&#x5230;&#x4EE3;&#x7801;&#x91CC;&#x7684;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;scsi_send_eh_cmnd&#xFF0C;&#x786E;&#x5B9E;&#x53D1;&#x73B0;&#x6709;&#x4E2A;timeout&#x7684;&#x5730;&#x65B9;&#xFF1A;&#x4E0D;&#x8FC7;&#x4E00;&#x5904;&#x662F;queuecommand&#x5931;&#x8D25;&#x540E;&#x6BCF;&#x6B21;sleep&#x4E00;&#x70B9;&#x65F6;&#x95F4;&#x7136;&#x540E;&#x91CD;&#x8BD5;&#xFF0C;&#x53E6;&#x5916;&#x4E00;&#x5904;&#x662F;queuecommand&#x6210;&#x529F;&#x540E;wait_for_completion_timeout&#x7B49;&#x5F85;cmd&#x5B8C;&#x6210;&#x3002;&#x5E76;&#x4E14;&#x4F20;&#x5165;scsi_send_eh_cmnd&#x7684;&#x53C2;&#x6570;&#x91CC;&#x7684;timeout&#x5C31;&#x662F;SENSE_TIMEOUT&#xFF08;&#x521A;&#x597D;&#x662F;10*HZ&#xFF09;&#x3002;&#x540E;&#x6765;&#x786E;&#x8BA4;&#x5F53;&#x524D;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x6838;&#x7248;&#x672C;3.10.45&#x91CC;&#x8FD9;&#x4E2A;&#x503C;&#x662F;&#x5199;&#x6B7B;&#x7684;&#xFF0C;&#x800C;&#x9AD8;&#x4E00;&#x70B9;&#x7684;&#x5185;&#x6838;&#xFF08;&#x5982;3.14.57&#xFF09;&#x8FD9;&#x4E2A;&#x503C;&#x5C31;&#x662F;&#x53EF;&#x914D;&#x7F6E;&#x7684;&#x53C2;&#x6570;eh_timeout&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">static int scsi_send_eh_cmnd(struct scsi_cmnd *scmd, unsigned char *cmnd,</span><br><span class="line">			     int cmnd_size, int timeout, unsigned sense_bytes)</span><br><span class="line">{</span><br><span class="line">	struct scsi_device *sdev = scmd-&gt;device;</span><br><span class="line">	struct Scsi_Host *shost = sdev-&gt;host;</span><br><span class="line">	DECLARE_COMPLETION_ONSTACK(done);</span><br><span class="line">	unsigned long timeleft = timeout;</span><br><span class="line">	struct scsi_eh_save ses;</span><br><span class="line">	const unsigned long stall_for = msecs_to_jiffies(100);</span><br><span class="line">	int rtn;</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line">	scsi_eh_prep_cmnd(scmd, &amp;ses, cmnd, cmnd_size, sense_bytes);</span><br><span class="line">	shost-&gt;eh_action = &amp;done;</span><br><span class="line"></span><br><span class="line">	scsi_log_send(scmd);</span><br><span class="line">	scmd-&gt;scsi_done = scsi_eh_done;</span><br><span class="line">	rtn = shost-&gt;hostt-&gt;queuecommand(shost, scmd);</span><br><span class="line">	if (rtn) {</span><br><span class="line">		if (timeleft &gt; stall_for) {</span><br><span class="line">			scsi_eh_restore_cmnd(scmd, &amp;ses);</span><br><span class="line">			timeleft -= stall_for;</span><br><span class="line">			msleep(jiffies_to_msecs(stall_for));</span><br><span class="line">			goto retry;</span><br><span class="line">		}</span><br><span class="line">		/* signal not to enter either branch of the if () below */</span><br><span class="line">		timeleft = 0;</span><br><span class="line">		rtn = NEEDS_RETRY;</span><br><span class="line">	} else {</span><br><span class="line">		timeleft = wait_for_completion_timeout(&amp;done, timeout);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	shost-&gt;eh_action = NULL;</span><br><span class="line"></span><br><span class="line">	scsi_log_completion(scmd, rtn);</span><br><span class="line">    // &#x8FD9;&#x91CC;&#x6253;&#x5370;&#x7684;&#x65E5;&#x5FD7;</span><br><span class="line">	SCSI_LOG_ERROR_RECOVERY(3,</span><br><span class="line">		printk(&quot;%s: scmd: %p, timeleft: %ld\n&quot;,</span><br><span class="line">			__func__, scmd, timeleft));</span><br><span class="line">	..........</span><br></pre></td></tr></table></figure></p>
<p>&#x6709;&#x4E86;&#x8FD9;&#x4E2A;&#x7EBF;&#x7D22;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x91CD;&#x73B0;&#x51FA;&#x6765;&#x786E;&#x8BA4;&#xFF0C;&#x4F46;&#x662F;&#x56E0;&#x4E3A;&#x662F;&#x5185;&#x6838;&#x4EE3;&#x7801;&#xFF0C;&#x4E0D;&#x53EF;&#x80FD;&#x76F4;&#x63A5;&#x53BB;&#x6253;&#x5370;&#x65E5;&#x5FD7;&#x91CD;&#x7F16;&#x8BD1;&#x5185;&#x6838;&#xFF0C;&#x56E0;&#x6B64;&#x796D;&#x51FA;&#x795E;&#x5668;systemtap&#xFF0C;&#x5728;&#x5173;&#x952E;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x5730;&#x65B9;&#x6253;&#x5370;&#x4FE1;&#x606F;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x91CD;&#x73B0;&#x6D4B;&#x8BD5;&#x8FC7;&#x7A0B;&#x4E2D;systemtap&#x6253;&#x5370;&#x7684;&#x76F8;&#x5173;&#x65E5;&#x5FD7;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x786E;&#x5B9E;&#x662F;&#x5728;wait_for_completion_timeout&#x8FD9;&#x91CC;&#x7B49;&#x4E86;10s&#x3002;&#x540C;&#x6837;&#x7684;&#x5728;&#x88F8;&#x76D8;fio&#x6D4B;&#x8BD5;&#x8FC7;&#x7A0B;&#x4E2D;systemtap&#x6293;&#x53D6;&#x5C31;&#x53D1;&#x73B0;wait_for_completion_timeout&#x6CA1;&#x6709;&#x7B49;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Fri Feb 10 09:12:55 2017, iscsi_queuecommand call: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380</span><br><span class="line">Fri Feb 10 09:12:55 2017, iscsi_queuecommand return: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380, return=0</span><br><span class="line">Fri Feb 10 09:12:55 2017, iscsi_queuecommand call: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff8821a2794080</span><br><span class="line">Fri Feb 10 09:12:55 2017, iscsi_queuecommand return: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff8821a2794080, return=0</span><br><span class="line">Fri Feb 10 09:12:59 2017, scsi_send_eh_cmnd enter: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380, sense_timeout:2500</span><br><span class="line">Fri Feb 10 09:12:59 2017, iscsi_queuecommand call: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380</span><br><span class="line">Fri Feb 10 09:12:59 2017, iscsi_queuecommand return: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380, return=0</span><br><span class="line">Fri Feb 10 09:12:59 2017, wait_for_completion_timeout</span><br><span class="line">Fri Feb 10 09:13:09 2017, scsi_send_eh_cmnd return: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380, sense_timeout:2500</span><br><span class="line"></span><br><span class="line">Fri Feb 10 09:13:09 2017, scsi_send_eh_cmnd enter: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380, sense_timeout:2500</span><br><span class="line">Fri Feb 10 09:13:09 2017, iscsi_queuecommand call: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380</span><br><span class="line">Fri Feb 10 09:13:09 2017, iscsi_queuecommand return: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380, return=0</span><br><span class="line">Fri Feb 10 09:13:09 2017, wait_for_completion_timeout</span><br><span class="line">Fri Feb 10 09:13:19 2017, scsi_send_eh_cmnd return: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380, sense_timeout:2500</span><br><span class="line"></span><br><span class="line">Fri Feb 10 09:13:19 2017, scsi_send_eh_cmnd enter: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380, sense_timeout:2500</span><br><span class="line">Fri Feb 10 09:13:19 2017, iscsi_queuecommand call: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380</span><br><span class="line">Fri Feb 10 09:13:19 2017, iscsi_queuecommand return: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380, return=0</span><br><span class="line">Fri Feb 10 09:13:19 2017, wait_for_completion_timeout</span><br><span class="line">Fri Feb 10 09:13:29 2017, scsi_send_eh_cmnd return: host_no=56, channel=0, lun=11, dev_id=0, scmd:0xffff880ec9618380, sense_timeout:2500</span><br></pre></td></tr></table></figure></p>
<p>&#x7ED3;&#x5408;&#x5185;&#x6838;&#x4EE3;&#x7801;&#x5206;&#x6790;&#xFF0C;&#x5728;scsi_eh_abort_cmds&#x2013;&gt;scsi_eh_test_devices&#x2013;&gt;scsi_eh_tur&#x2013;&gt;scsi_send_eh_cmnd&#x7684;&#x8C03;&#x7528;&#x8DEF;&#x5F84;&#x4E0B;&#xFF0C;&#x5F53;scsi_send_eh_cmnd&#x8D85;&#x65F6;&#x8FD4;&#x56DE;FAILED&#xFF0C;&#x4ECE;&#x800C;&#x8FDB;&#x5165;&#x5230;scsi_eh_ready_devs&#x7684;&#x5904;&#x7406;&#x6D41;&#x7A0B;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">static void scsi_unjam_host(struct Scsi_Host *shost)</span><br><span class="line">{</span><br><span class="line">	unsigned long flags;</span><br><span class="line">	LIST_HEAD(eh_work_q);</span><br><span class="line">	LIST_HEAD(eh_done_q);</span><br><span class="line"></span><br><span class="line">	spin_lock_irqsave(shost-&gt;host_lock, flags);</span><br><span class="line">	list_splice_init(&amp;shost-&gt;eh_cmd_q, &amp;eh_work_q);</span><br><span class="line">	spin_unlock_irqrestore(shost-&gt;host_lock, flags);</span><br><span class="line"></span><br><span class="line">	SCSI_LOG_ERROR_RECOVERY(1, scsi_eh_prt_fail_stats(shost, &amp;eh_work_q));</span><br><span class="line"></span><br><span class="line">	if (!scsi_eh_get_sense(&amp;eh_work_q, &amp;eh_done_q))</span><br><span class="line">		if (!scsi_eh_abort_cmds(&amp;eh_work_q, &amp;eh_done_q))</span><br><span class="line">			scsi_eh_ready_devs(shost, &amp;eh_work_q, &amp;eh_done_q);</span><br><span class="line"></span><br><span class="line">	scsi_eh_flush_done_q(&amp;eh_done_q);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x5728;scsi_eh_ready_devs&#x91CC;&#xFF0C;&#x5C31;&#x4F1A;&#x76F8;&#x7EE7;&#x8C03;&#x7528;scsi_eh_bus_device_reset&#xFF0C;scsi_eh_target_reset&#xFF0C;scsi_eh_bus_reset&#x7B49;&#xFF0C;&#x5C31;&#x5728;scsi_eh_bus_device_reset&#x548C;scsi_eh_target_reset&#x91CC;&#x6700;&#x7EC8;&#x90FD;&#x4F1A;&#x8C03;&#x7528;&#x5230;scsi_eh_tur&#x2013;&gt;scsi_send_eh_cmnd&#x7684;&#x903B;&#x8F91;&#xFF0C;&#x5E76;&#x4E14;&#x5404;&#x81EA;&#x53C8;&#x7B49;&#x5F85;&#x4E86;10s&#xFF0C;&#x5E76;&#x4E14;&#x6700;&#x540E;&#x8D70;&#x5230;&#x4E86;scsi_eh_offline_sdevs&#x5C06;&#x8BBE;&#x5907;&#x79BB;&#x7EBF;&#xFF0C;&#x4ECE;&#x800C;&#x603B;&#x7684;&#x5BFC;&#x81F4;&#x4E86;3&#x6B21;10s&#x7684;&#x8D85;&#x65F6;&#xFF0C;&#x4E0E;&#x4E0A;&#x9762;&#x7684;&#x65E5;&#x5FD7;&#x543B;&#x5408;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">void scsi_eh_ready_devs(struct Scsi_Host *shost,</span><br><span class="line">			struct list_head *work_q,</span><br><span class="line">			struct list_head *done_q)</span><br><span class="line">{</span><br><span class="line">	if (!scsi_eh_stu(shost, work_q, done_q))</span><br><span class="line">		if (!scsi_eh_bus_device_reset(shost, work_q, done_q))</span><br><span class="line">			if (!scsi_eh_target_reset(shost, work_q, done_q))</span><br><span class="line">				if (!scsi_eh_bus_reset(shost, work_q, done_q))</span><br><span class="line">					if (!scsi_eh_host_reset(work_q, done_q))</span><br><span class="line">						scsi_eh_offline_sdevs(work_q,</span><br><span class="line">								      done_q);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<h2 id="&#x4E3A;&#x4EC0;&#x4E48;&#x53D1;&#x9001;&#x7684;TUR-TEST-UNIT-READY-&#x547D;&#x4EE4;&#x4F1A;&#x8D85;&#x65F6;"><a href="#&#x4E3A;&#x4EC0;&#x4E48;&#x53D1;&#x9001;&#x7684;TUR-TEST-UNIT-READY-&#x547D;&#x4EE4;&#x4F1A;&#x8D85;&#x65F6;" class="headerlink" title="&#x4E3A;&#x4EC0;&#x4E48;&#x53D1;&#x9001;&#x7684;TUR(TEST UNIT READY)&#x547D;&#x4EE4;&#x4F1A;&#x8D85;&#x65F6;"></a>&#x4E3A;&#x4EC0;&#x4E48;&#x53D1;&#x9001;&#x7684;TUR(TEST UNIT READY)&#x547D;&#x4EE4;&#x4F1A;&#x8D85;&#x65F6;</h2><h3 id="&#x7F51;&#x7EDC;&#x5305;&#x5206;&#x6790;"><a href="#&#x7F51;&#x7EDC;&#x5305;&#x5206;&#x6790;" class="headerlink" title="&#x7F51;&#x7EDC;&#x5305;&#x5206;&#x6790;"></a>&#x7F51;&#x7EDC;&#x5305;&#x5206;&#x6790;</h3><p>&#x4E3A;&#x4E86;&#x5206;&#x6790;&#x4E3A;&#x4EC0;&#x4E48;scsi_send_eh_cmnd&#x53D1;&#x9001;TUR&#x6307;&#x4EE4;&#x5230;target&#x53BB;&#x5904;&#x7406;&#x4F1A;&#x8D85;&#x65F6;&#xFF0C;&#x9996;&#x5148;&#x60F3;&#x5230;&#x7684;&#x5C31;&#x662F;&#x6293;&#x5305;&#x5206;&#x6790;&#xFF0C;&#x5BF9;&#x6BD4;2&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF08;&#x88F8;&#x76D8;&#x6D4B;&#x8BD5;&#x548C;&#x4ECE;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E0A;&#x6D4B;&#x8BD5;&#xFF09;&#x7684;&#x5305;&#x5904;&#x7406;&#x6709;&#x4EC0;&#x4E48;&#x4E0D;&#x540C;&#x3002;<br>1&#xFF09;&#x88F8;&#x76D8;&#x6D4B;&#x8BD5;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;tcpdump&#x6293;&#x53D6;&#x5305;&#xFF0C;&#x7136;&#x540E;&#x4F7F;&#x7528;wireshark&#x5206;&#x6790;<br><img src="/2017/03/15/error-disk-cause-iohang2/test_naked_TUR_packet.png" alt="error-disk-cause-iohang2"><br>2&#xFF09;&#x4ECE;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E0A;&#x53BB;&#x6D4B;&#x8BD5;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;tcpdump&#x6293;&#x53D6;&#x5305;&#xFF0C;&#x901A;&#x8FC7;wireshark&#x5206;&#x6790;<br><img src="/2017/03/15/error-disk-cause-iohang2/test_fs_TUR_packet.png" alt="error-disk-cause-iohang2"><br>&#x4ECE;&#x4E0A;&#x9762;&#x4E24;&#x56FE;&#x7684;&#x5BF9;&#x6BD4;&#x5C31;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#xFF0C;&#x5F53;&#x4ECE;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x6D4B;&#x8BD5;&#x8FC7;&#x7A0B;&#x4E2D;&#x67D0;&#x4E2A;&#x65F6;&#x5019;&#x5F00;&#x59CB;initiator&#x53D1;&#x9001;&#x7ED9;target&#x7684;TUR&#x6D88;&#x606F;&#x6CA1;&#x6709;&#x6536;&#x5230;&#x54CD;&#x5E94;&#xFF0C;&#x65E2;&#x7136;&#x6CA1;&#x6709;&#x54CD;&#x5E94;&#xFF0C;&#x90A3;&#x5C31;&#x8BF4;&#x660E;target&#x7AEF;&#x5904;&#x7406;&#x4E0A;&#x6709;&#x95EE;&#x9898;&#x5BFC;&#x81F4;&#x6CA1;&#x6709;&#x56DE;&#x5305;&#x3002;</p>
<h3 id="iscsitarget&#x7AEF;&#x5206;&#x6790;"><a href="#iscsitarget&#x7AEF;&#x5206;&#x6790;" class="headerlink" title="iscsitarget&#x7AEF;&#x5206;&#x6790;"></a>iscsitarget&#x7AEF;&#x5206;&#x6790;</h3><p>iscsitarget&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x53EA;&#x6709;error&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x6BD4;&#x8F83;&#x5C11;&#xFF0C;&#x4E0D;&#x4FBF;&#x4E8E;&#x5206;&#x6790;&#x95EE;&#x9898;&#xFF0C;&#x56E0;&#x6B64;&#x9488;&#x5BF9;TEST UNIT READY&#x6307;&#x4EE4;&#x7684;&#x5904;&#x7406;&#x5730;&#x65B9;&#x52A0;&#x4E0A;debug&#x65E5;&#x5FD7;&#xFF0C;&#x7136;&#x540E;&#x91CD;&#x65B0;&#x7F16;&#x8BD1;&#x6A21;&#x5757;&#xFF0C;&#x5E76;&#x4E14;&#x5F00;&#x542F;iscsitarget&#x81EA;&#x5E26;&#x7684;debug&#x65E5;&#x5FD7;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo insmod iscsi_trgt.ko debug_enable_flags=255</span><br></pre></td></tr></table></figure></p>
<p>&#x7136;&#x540E;&#x518D;&#x6B21;&#x4ECE;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x5C42;&#x9762;&#x6D4B;&#x8BD5;&#x6765;&#x91CD;&#x73B0;&#xFF0C;&#x91CD;&#x70B9;&#x5173;&#x6CE8;target&#x7AEF;&#x7684;&#x65E5;&#x5FD7;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">Feb 15 15:38:41 10-165-160-13 kernel: [2243339.970923] iscsi_trgt: Abort Task (01) issued on tid:1000 lun:0 by sid:281475098149376 (Function Complete)</span><br><span class="line">Feb 15 15:38:41 10-165-160-13 kernel: [2243339.970935] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:41 10-165-160-13 kernel: [2243339.971091] iscsi_trgt: Abort Task (01) issued on tid:1000 lun:0 by sid:281475098149376 (Function Complete)</span><br><span class="line">Feb 15 15:38:41 10-165-160-13 kernel: [2243339.971098] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:41 10-165-160-13 kernel: [2243339.971232] iscsi_trgt: scsi_cmnd_start(996) 6a000030 0 TEST_UNIT_READY</span><br><span class="line">Feb 15 15:38:41 10-165-160-13 kernel: [2243339.971517] iscsi_trgt: disk_execute_cmnd(638) disk_execute_cmnd 6a000030 0 TEST_UNIT_READY</span><br><span class="line">Feb 15 15:38:41 10-165-160-13 kernel: [2243339.971859] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:42 10-165-160-13 kernel: [2243340.978354] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:44 10-165-160-13 kernel: [2243342.981374] iscsi_trgt: Abort Task (01) issued on tid:1000 lun:0 by sid:281475098149376 (Function Complete)</span><br><span class="line">Feb 15 15:38:44 10-165-160-13 kernel: [2243342.981385] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:44 10-165-160-13 kernel: [2243342.981489] iscsi_trgt: Abort Task (01) issued on tid:1000 lun:0 by sid:281475098149376 (Function Complete)</span><br><span class="line">Feb 15 15:38:44 10-165-160-13 kernel: [2243342.981496] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:44 10-165-160-13 kernel: [2243342.981621] iscsi_trgt: scsi_cmnd_start(996) 74000030 0 TEST_UNIT_READY</span><br><span class="line">Feb 15 15:38:44 10-165-160-13 kernel: [2243342.981914] iscsi_trgt: disk_execute_cmnd(638) disk_execute_cmnd 74000030 0 TEST_UNIT_READY</span><br><span class="line">Feb 15 15:38:44 10-165-160-13 kernel: [2243342.982256] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:46 10-165-160-13 kernel: [2243344.980338] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:48 10-165-160-13 kernel: [2243346.979438] iscsi_trgt: Abort Task (01) issued on tid:1000 lun:0 by sid:281475098149376 (Function Complete)</span><br><span class="line">Feb 15 15:38:48 10-165-160-13 kernel: [2243346.979451] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:48 10-165-160-13 kernel: [2243346.979570] iscsi_trgt: Abort Task (01) issued on tid:1000 lun:0 by sid:281475098149376 (Function Complete)</span><br><span class="line">Feb 15 15:38:48 10-165-160-13 kernel: [2243346.979578] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:48 10-165-160-13 kernel: [2243346.979702] iscsi_trgt: scsi_cmnd_start(996) 7a000030 0 TEST_UNIT_READY</span><br><span class="line">Feb 15 15:38:48 10-165-160-13 kernel: [2243346.979987] iscsi_trgt: disk_execute_cmnd(638) disk_execute_cmnd 7a000030 0 TEST_UNIT_READY</span><br><span class="line">Feb 15 15:38:48 10-165-160-13 kernel: [2243346.980318] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:50 10-165-160-13 kernel: [2243348.978415] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:52 10-165-160-13 kernel: [2243350.977497] iscsi_trgt: Abort Task (01) issued on tid:1000 lun:0 by sid:281475098149376 (Function Complete)</span><br><span class="line">Feb 15 15:38:52 10-165-160-13 kernel: [2243350.977511] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:52 10-165-160-13 kernel: [2243350.977628] iscsi_trgt: Abort Task (01) issued on tid:1000 lun:0 by sid:281475098149376 (Function Complete)</span><br><span class="line">Feb 15 15:38:52 10-165-160-13 kernel: [2243350.977635] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:38:52 10-165-160-13 kernel: [2243350.977766] iscsi_trgt: scsi_cmnd_start(996) 79000030 0 TEST_UNIT_READY</span><br><span class="line">###########&#x8FD9;&#x91CC;&#x53D1;&#x7684;TEST_UNIT_READY&#x6CA1;&#x6709;&#x63A5;&#x4E0B;&#x53BB;&#x8C03;&#x7528;disk_execute_cmnd</span><br><span class="line">Feb 15 15:38:57 10-165-160-13 kernel: [2243355.978980] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:39:02 10-165-160-13 kernel: [2243360.972560] iscsi_trgt: Abort Task (01) issued on tid:1000 lun:0 by sid:281475098149376 (Function Complete)</span><br><span class="line">Feb 15 15:39:02 10-165-160-13 kernel: [2243360.972571] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:39:02 10-165-160-13 kernel: [2243360.972741] iscsi_trgt: Logical Unit Reset (05) issued on tid:1000 lun:0 by sid:281475098149376 (Function Complete)</span><br><span class="line">Feb 15 15:39:02 10-165-160-13 kernel: [2243360.972748] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:39:02 10-165-160-13 kernel: [2243360.972887] iscsi_trgt: scsi_cmnd_start(996) 2000030 0 TEST_UNIT_READY</span><br><span class="line">###########&#x8FD9;&#x91CC;&#x53D1;&#x7684;TEST_UNIT_READY&#x6CA1;&#x6709;&#x63A5;&#x4E0B;&#x53BB;&#x8C03;&#x7528;disk_execute_cmnd</span><br><span class="line">Feb 15 15:39:07 10-165-160-13 kernel: [2243365.982080] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:39:12 10-165-160-13 kernel: [2243370.967665] iscsi_trgt: Abort Task (01) issued on tid:1000 lun:0 by sid:281475098149376 (Function Complete)</span><br><span class="line">Feb 15 15:39:12 10-165-160-13 kernel: [2243370.967680] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:39:12 10-165-160-13 kernel: [2243370.967849] iscsi_trgt: Target Warm Reset (06) issued on tid:1000 lun:0 by sid:281475098149376 (Function Complete)</span><br><span class="line">Feb 15 15:39:12 10-165-160-13 kernel: [2243370.967857] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:39:12 10-165-160-13 kernel: [2243370.968009] iscsi_trgt: scsi_cmnd_start(996) 1000030 0 TEST_UNIT_READY</span><br><span class="line">###########&#x8FD9;&#x91CC;&#x53D1;&#x7684;TEST_UNIT_READY&#x6CA1;&#x6709;&#x63A5;&#x4E0B;&#x53BB;&#x8C03;&#x7528;disk_execute_cmnd</span><br><span class="line">Feb 15 15:39:17 10-165-160-13 kernel: [2243375.981201] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 15:39:22 10-165-160-13 kernel: [2243380.962731] iscsi_trgt: Abort Task (01) issued on tid:1000 lun:0 by sid:281475098149376 (Function Complete)</span><br><span class="line">Feb 15 15:39:22 10-165-160-13 kernel: [2243380.962743] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br></pre></td></tr></table></figure></p>
<p>&#x8FD9;&#x91CC;&#x65E5;&#x5FD7;&#x8FD8;&#x4E0D;&#x591F;&#x8BE6;&#x7EC6;&#xFF0C;&#x518D;&#x9488;&#x5BF9;&#x6027;&#x7684;&#x628A;cmnd&#x5904;&#x7406;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#x90FD;&#x6253;&#x5370;&#x51FA;&#x6765;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.387487] iscsi_trgt: do_recv(144) 48</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.387489] iscsi_trgt: cmnd_insert_hash(641) ffff885f5a75a830:b0000054</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.387492] iscsi_trgt: check_cmd_sn(567) cmd_sn(10417) exp_cmd_sn(10417) max_cmd_sn(10449)</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.387494] iscsi_trgt: update_stat_sn(551) 1,350</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.387495] iscsi_trgt: scsi_cmnd_start(982) scsi command: 00</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.387498] iscsi_trgt: scsi_cmnd_start(1007) 540000b0 0 TEST_UNIT_READY</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.394591] iscsi_trgt: cmnd_rx_end(1970) ffff885f5a75a830:1</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.394593] iscsi_trgt: iscsi_session_push_cmnd(1865) ffff885f5a75a830:1 10417,10417</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.394595] iscsi_trgt: iscsi_cmnd_exec(1620) ffff885f5a75a830,1,10417</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.394597] iscsi_trgt: iscsi_scsi_queuecmnd(64) ffff885f5a75a830</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.394600] iscsi_trgt: iscsi_scsi_queuecmnd(76) iscsi_scsi_queuecmnd queue_lock aquired, 540000b0 0</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.401931] iscsi_trgt: wthread_queue(35) wthread_queue put cmnd:ffff885f5a75a830 to work_queue, 540000b0 0</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.409500] iscsi_trgt: iscsi_scsi_queuecmnd(95) iscsi_scsi_queuecmnd device queue cmnd:ffff885f5a75a830, 540000b0 0</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.409540] iscsi_trgt: get_ready_cmnd(53) get_ready_cmnd get cmnd:ffff885f5a75a830 to work_queue, 540000b0 0</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.409543] iscsi_trgt: disk_execute_cmnd(638) disk_execute_cmnd 540000b0 0 TEST_UNIT_READY</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.409546] iscsi_trgt: cmnd_alloc(180) ffff882f2ea0a000:ffff885f889e8488</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.409549] iscsi_trgt: iscsi_cmnds_init_write(221) ffff885f889e8488:21</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.433261] iscsi_trgt: cmnd_tx_start(1735) ffff885f889e8488:21</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.433268] iscsi_trgt: write_data(347) 0x10000073d0200:0: 48(48)</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.433270] iscsi_trgt: cmnd_tx_end(1810) ffff885f889e8488:21</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.433275] iscsi_trgt: cmnd_release(1693) cmnd_release cmnd:ffff885f889e8488, 21 4 0</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.441226] iscsi_trgt: iscsi_cmnd_remove(441) ffff885f889e8488</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.441229] iscsi_trgt: cmnd_release(1693) cmnd_release cmnd:ffff885f5a75a830, 1 24b 0</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.448959] iscsi_trgt: iscsi_cmnd_remove(441) ffff885f5a75a830</span><br><span class="line">Feb 15 17:40:47 10-165-160-13 kernel: [2250662.448963] iscsi_trgt: cmnd_alloc(180) ffff882f2ea0a000:ffff885f5a75a830</span><br><span class="line">.............&#x4E0B;&#x9762;3&#x6B21;&#x662F;TEST_UNIT_READY&#x8BF7;&#x6C42;&#x6CA1;&#x80FD;&#x6B63;&#x5E38;&#x5904;&#x7406;&#x7684;&#x65E5;&#x5FD7;</span><br><span class="line">Feb 15 17:40:51 10-165-160-13 kernel: [2250666.385455] iscsi_trgt: do_recv(144) 48</span><br><span class="line">Feb 15 17:40:51 10-165-160-13 kernel: [2250666.385457] iscsi_trgt: cmnd_insert_hash(641) ffff885f88a4f120:b000005d</span><br><span class="line">Feb 15 17:40:51 10-165-160-13 kernel: [2250666.385460] iscsi_trgt: check_cmd_sn(567) cmd_sn(10420) exp_cmd_sn(10420) max_cmd_sn(10452)</span><br><span class="line">Feb 15 17:40:51 10-165-160-13 kernel: [2250666.385461] iscsi_trgt: update_stat_sn(551) 1,354</span><br><span class="line">Feb 15 17:40:51 10-165-160-13 kernel: [2250666.385463] iscsi_trgt: scsi_cmnd_start(982) scsi command: 00</span><br><span class="line">Feb 15 17:40:51 10-165-160-13 kernel: [2250666.385466] iscsi_trgt: scsi_cmnd_start(1007) 5d0000b0 0 TEST_UNIT_READY</span><br><span class="line">Feb 15 17:40:51 10-165-160-13 kernel: [2250666.392490] iscsi_trgt: cmnd_rx_end(1970) ffff885f88a4f120:1</span><br><span class="line">Feb 15 17:40:51 10-165-160-13 kernel: [2250666.392493] iscsi_trgt: iscsi_session_push_cmnd(1865) ffff885f88a4f120:1 10420,10420</span><br><span class="line">Feb 15 17:40:51 10-165-160-13 kernel: [2250666.392495] iscsi_trgt: iscsi_cmnd_exec(1620) ffff885f88a4f120,1,10420</span><br><span class="line">Feb 15 17:40:51 10-165-160-13 kernel: [2250666.392496] iscsi_trgt: iscsi_scsi_queuecmnd(64) ffff885f88a4f120</span><br><span class="line">Feb 15 17:40:51 10-165-160-13 kernel: [2250666.392499] iscsi_trgt: iscsi_scsi_queuecmnd(76) iscsi_scsi_queuecmnd queue_lock aquired, 5d0000b0 0</span><br><span class="line">Feb 15 17:40:51 10-165-160-13 kernel: [2250666.399778] iscsi_trgt: wthread_queue(35) wthread_queue put cmnd:ffff885f88a4f120 to work_queue, 5d0000b0 0</span><br><span class="line">Feb 15 17:40:51 10-165-160-13 kernel: [2250666.407283] iscsi_trgt: iscsi_scsi_queuecmnd(95) iscsi_scsi_queuecmnd device queue cmnd:ffff885f88a4f120, 5d0000b0 0</span><br><span class="line">Feb 15 17:40:56 10-165-160-13 kernel: [2250671.370526] iscsi_trgt: cmnd_alloc(180) ffff882f2ea0a000:ffff885f88a4f258</span><br><span class="line">..............</span><br><span class="line">Feb 15 17:41:01 10-165-160-13 kernel: [2250676.393762] iscsi_trgt: do_recv(144) 48</span><br><span class="line">Feb 15 17:41:01 10-165-160-13 kernel: [2250676.393764] iscsi_trgt: cmnd_insert_hash(641) ffff885f88a4f258:b0000056</span><br><span class="line">Feb 15 17:41:01 10-165-160-13 kernel: [2250676.393766] iscsi_trgt: check_cmd_sn(567) cmd_sn(10421) exp_cmd_sn(10421) max_cmd_sn(10453)</span><br><span class="line">Feb 15 17:41:01 10-165-160-13 kernel: [2250676.393768] iscsi_trgt: update_stat_sn(551) 1,357</span><br><span class="line">Feb 15 17:41:01 10-165-160-13 kernel: [2250676.393770] iscsi_trgt: scsi_cmnd_start(982) scsi command: 00</span><br><span class="line">Feb 15 17:41:01 10-165-160-13 kernel: [2250676.393772] iscsi_trgt: scsi_cmnd_start(1007) 560000b0 0 TEST_UNIT_READY</span><br><span class="line">Feb 15 17:41:01 10-165-160-13 kernel: [2250676.400617] iscsi_trgt: cmnd_rx_end(1970) ffff885f88a4f258:1</span><br><span class="line">Feb 15 17:41:01 10-165-160-13 kernel: [2250676.400619] iscsi_trgt: iscsi_session_push_cmnd(1865) ffff885f88a4f258:1 10421,10421</span><br><span class="line">Feb 15 17:41:01 10-165-160-13 kernel: [2250676.400621] iscsi_trgt: iscsi_cmnd_exec(1620) ffff885f88a4f258,1,10421</span><br><span class="line">Feb 15 17:41:01 10-165-160-13 kernel: [2250676.400623] iscsi_trgt: iscsi_scsi_queuecmnd(64) ffff885f88a4f258</span><br><span class="line">Feb 15 17:41:01 10-165-160-13 kernel: [2250676.400625] iscsi_trgt: iscsi_scsi_queuecmnd(76) iscsi_scsi_queuecmnd queue_lock aquired, 560000b0 0</span><br><span class="line">Feb 15 17:41:01 10-165-160-13 kernel: [2250676.407563] iscsi_trgt: wthread_queue(35) wthread_queue put cmnd:ffff885f88a4f258 to work_queue, 560000b0 0</span><br><span class="line">Feb 15 17:41:01 10-165-160-13 kernel: [2250676.414738] iscsi_trgt: iscsi_scsi_queuecmnd(95) iscsi_scsi_queuecmnd device queue cmnd:ffff885f88a4f258, 560000b0 0</span><br><span class="line">Feb 15 17:41:06 10-165-160-13 kernel: [2250681.389629] iscsi_trgt: cmnd_alloc(180) ffff882f2ea0a000:ffff885f88a4f390</span><br><span class="line">...............</span><br><span class="line">Feb 15 17:41:11 10-165-160-13 kernel: [2250686.401385] iscsi_trgt: do_recv(144) 48</span><br><span class="line">Feb 15 17:41:11 10-165-160-13 kernel: [2250686.401387] iscsi_trgt: cmnd_insert_hash(641) ffff885f88a4f390:b0000068</span><br><span class="line">Feb 15 17:41:11 10-165-160-13 kernel: [2250686.401389] iscsi_trgt: check_cmd_sn(567) cmd_sn(10422) exp_cmd_sn(10422) max_cmd_sn(10454)</span><br><span class="line">Feb 15 17:41:11 10-165-160-13 kernel: [2250686.401391] iscsi_trgt: update_stat_sn(551) 1,35a</span><br><span class="line">Feb 15 17:41:11 10-165-160-13 kernel: [2250686.401393] iscsi_trgt: scsi_cmnd_start(982) scsi command: 00</span><br><span class="line">Feb 15 17:41:11 10-165-160-13 kernel: [2250686.401395] iscsi_trgt: scsi_cmnd_start(1007) 680000b0 0 TEST_UNIT_READY</span><br><span class="line">Feb 15 17:41:11 10-165-160-13 kernel: [2250686.408639] iscsi_trgt: cmnd_rx_end(1970) ffff885f88a4f390:1</span><br><span class="line">Feb 15 17:41:11 10-165-160-13 kernel: [2250686.408641] iscsi_trgt: iscsi_session_push_cmnd(1865) ffff885f88a4f390:1 10422,10422</span><br><span class="line">Feb 15 17:41:11 10-165-160-13 kernel: [2250686.408643] iscsi_trgt: iscsi_cmnd_exec(1620) ffff885f88a4f390,1,10422</span><br><span class="line">Feb 15 17:41:11 10-165-160-13 kernel: [2250686.408645] iscsi_trgt: iscsi_scsi_queuecmnd(64) ffff885f88a4f390</span><br><span class="line">Feb 15 17:41:11 10-165-160-13 kernel: [2250686.408647] iscsi_trgt: iscsi_scsi_queuecmnd(76) iscsi_scsi_queuecmnd queue_lock aquired, 680000b0 0</span><br><span class="line">Feb 15 17:41:11 10-165-160-13 kernel: [2250686.415920] iscsi_trgt: wthread_queue(35) wthread_queue put cmnd:ffff885f88a4f390 to work_queue, 680000b0 0</span><br><span class="line">Feb 15 17:41:11 10-165-160-13 kernel: [2250686.423196] iscsi_trgt: iscsi_scsi_queuecmnd(95) iscsi_scsi_queuecmnd device queue cmnd:ffff885f88a4f390, 680000b0 0</span><br><span class="line">Feb 15 17:41:16 10-165-160-13 kernel: [2250691.384730] iscsi_trgt: cmnd_alloc(180) ffff882f2ea0a000:ffff885f88a4f4c8</span><br><span class="line">...........</span><br></pre></td></tr></table></figure></p>
<p>&#x901A;&#x8FC7;&#x65E5;&#x5FD7;&#x5E76;&#x7ED3;&#x5408;iscsitarget&#x7684;&#x6E90;&#x7801;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#xFF0C;TEST_UNIT_READY&#x8BF7;&#x6C42;&#x53D1;&#x9001;&#x5230;target&#x540E;&#xFF0C;&#x7531;target&#x7684;&#x7F51;&#x7EDC;&#x7EBF;&#x7A0B;&#x8FDB;&#x884C;&#x5305;&#x89E3;&#x6790;&#x7B49;&#x5904;&#x7406;&#x540E;&#xFF0C;&#x8C03;&#x7528;wthread_queue&#x5C06;cmnd&#x653E;&#x5230;target&#x7684;work_queue&#x91CC;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;wake_up()&#x53BB;&#x5524;&#x9192;target&#x7684;IO&#x7EBF;&#x7A0B;&#x53BB;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x3002;&#x6B63;&#x5E38;&#x60C5;&#x51B5;&#x4E0B;IO&#x7EBF;&#x7A0B;&#x88AB;&#x5524;&#x9192;&#x540E;&#x4ECE;work_queue&#x91CC;&#x53D6;cmnd&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;disk_execute_cmnd&#x8FDB;&#x884C;&#x5904;&#x7406;&#x3002;&#x4F46;&#x662F;&#x4ECE;&#x4E0A;&#x9762;&#x65E5;&#x5FD7;&#x91CC;&#x7684;&#x540E;3&#x6B21;TEST UNIT READY&#x8BF7;&#x6C42;&#x5904;&#x7406;&#x8FC7;&#x7A0B;&#x4E2D;&#x53D1;&#x73B0;&#x5F53;&#x628A;cmnd&#x653E;&#x5230;work_queue&#x540E;&#x8C03;&#x7528;wake_up()&#x540E;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;IO&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x7684;&#x65E5;&#x5FD7;&#x4E86;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">// &#x5C06;cmnd&#x653E;&#x5230;work_queue&#x5E76;wake_up&#x7684;&#x51FD;&#x6570;</span><br><span class="line">void wthread_queue(struct iscsi_cmnd *cmnd)</span><br><span class="line">{</span><br><span class="line">	struct worker_thread_info *info = cmnd-&gt;conn-&gt;session-&gt;target-&gt;wthread_info;</span><br><span class="line"></span><br><span class="line">	if (!list_empty(&amp;cmnd-&gt;list)) {</span><br><span class="line">		struct iscsi_scsi_cmd_hdr *req = cmnd_hdr(cmnd);</span><br><span class="line">		eprintk(&quot;%x %p %x %x %x %x %lx %x\n&quot;,</span><br><span class="line">			cmnd_itt(cmnd), req, req-&gt;opcode, req-&gt;scb[0], cmnd-&gt;pdu.datasize,</span><br><span class="line">			be32_to_cpu(req-&gt;data_length), cmnd-&gt;flags, req-&gt;flags);</span><br><span class="line"></span><br><span class="line">		if (cmnd-&gt;lun)</span><br><span class="line">			eprintk(&quot;%u\n&quot;, cmnd-&gt;lun-&gt;lun);</span><br><span class="line">		assert(list_empty(&amp;cmnd-&gt;list));</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;info-&gt;wthread_lock);</span><br><span class="line">	// for debug</span><br><span class="line">	struct iscsi_scsi_cmd_hdr *req = cmnd_hdr(cmnd);</span><br><span class="line">	if (req-&gt;scb[0] == TEST_UNIT_READY)</span><br><span class="line">		eprintk(&quot;wthread_queue put cmnd:%p to work_queue, %x %x\n&quot;, cmnd, cmnd_itt(cmnd), req-&gt;scb[0]);</span><br><span class="line">	list_add_tail(&amp;cmnd-&gt;list, &amp;info-&gt;work_queue);</span><br><span class="line">	spin_unlock(&amp;info-&gt;wthread_lock);</span><br><span class="line"></span><br><span class="line">	atomic_inc(&amp;cmnd-&gt;conn-&gt;nr_busy_cmnds);</span><br><span class="line"></span><br><span class="line">	wake_up(&amp;info-&gt;wthread_sleep);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// target&#x7684;IO&#x5904;&#x7406;&#x7EBF;&#x7A0B;</span><br><span class="line">static int worker_thread(void *arg)</span><br><span class="line">{</span><br><span class="line">	struct worker_thread *wt = (struct worker_thread *) arg;</span><br><span class="line">	struct worker_thread_info *info = wt-&gt;w_info;</span><br><span class="line">	struct iscsi_cmnd *cmnd;</span><br><span class="line">	struct iscsi_conn *conn;</span><br><span class="line">	DECLARE_WAITQUEUE(wait, current);</span><br><span class="line"></span><br><span class="line">	get_io_context(GFP_KERNEL, -1);</span><br><span class="line"></span><br><span class="line">	if (!current-&gt;io_context)</span><br><span class="line">		eprintk(&quot;%s\n&quot;, &quot;Failed to get IO context&quot;);</span><br><span class="line">	else if (info-&gt;wthread_ioc)</span><br><span class="line">		copy_io_context(&amp;current-&gt;io_context, &amp;info-&gt;wthread_ioc);</span><br><span class="line">	else</span><br><span class="line">		info-&gt;wthread_ioc = current-&gt;io_context;</span><br><span class="line"></span><br><span class="line">	add_wait_queue(&amp;info-&gt;wthread_sleep, &amp;wait);</span><br><span class="line"></span><br><span class="line">	__set_current_state(TASK_RUNNING);</span><br><span class="line">	do {</span><br><span class="line">		while (!list_empty(&amp;info-&gt;work_queue) &amp;&amp;</span><br><span class="line">		       (cmnd = get_ready_cmnd(info))) {</span><br><span class="line">			conn = cmnd-&gt;conn;</span><br><span class="line">			if (cmnd_tmfabort(cmnd))</span><br><span class="line">				cmnd_release(cmnd, 1);</span><br><span class="line">			else</span><br><span class="line">				cmnd_execute(cmnd);</span><br><span class="line">			assert(conn);</span><br><span class="line">			atomic_dec(&amp;conn-&gt;nr_busy_cmnds);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		set_current_state(TASK_INTERRUPTIBLE);</span><br><span class="line">		if (list_empty(&amp;info-&gt;work_queue))</span><br><span class="line">			schedule();</span><br><span class="line">        // &#x5982;&#x679C;&#x88AB;&#x5524;&#x9192;&#xFF0C;&#x5E94;&#x8BE5;&#x4F1A;&#x6253;&#x5370;&#x4E0B;&#x9762;&#x8FD9;&#x6761;&#x65E5;&#x5FD7;</span><br><span class="line">		eprintk(&quot;worker_thread:%d, waked up to running\n&quot;, current-&gt;pid);</span><br><span class="line">		__set_current_state(TASK_RUNNING);</span><br><span class="line">	} while (!kthread_should_stop());</span><br><span class="line"></span><br><span class="line">	remove_wait_queue(&amp;info-&gt;wthread_sleep, &amp;wait);</span><br><span class="line"></span><br><span class="line">	if (current-&gt;io_context) {</span><br><span class="line">		struct io_context *ioc = current-&gt;io_context;</span><br><span class="line"></span><br><span class="line">		task_lock(current);</span><br><span class="line">		current-&gt;io_context = NULL;</span><br><span class="line">		task_unlock(current);</span><br><span class="line"></span><br><span class="line">		put_io_context(ioc);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x8FD9;&#x8BF4;&#x660E;target&#x7684;IO&#x7EBF;&#x7A0B;&#x6CA1;&#x6709;&#x88AB;&#x6210;&#x529F;&#x5524;&#x9192;&#xFF0C;&#x56F0;&#x6270;&#x4E86;&#x4E00;&#x4F1A;&#xFF0C;&#x7ECF;&#x5185;&#x6838;&#x7684;&#x540C;&#x4E8B;&#x63D0;&#x9192;&#x53BB;&#x89C2;&#x5BDF;&#x8FD9;&#x4E9B;IO&#x7EBF;&#x7A0B;&#x90A3;&#x6BB5;&#x65F6;&#x95F4;&#x7684;&#x72B6;&#x6001;(cat /proc/<pid>/status)&#xFF0C;&#x770B;&#x770B;voluntary_ctxt_switches&#xFF08;&#x7EBF;&#x7A0B;&#x4E3B;&#x52A8;&#x5207;&#x6362;&#xFF09;&#x548C;nonvoluntary_ctxt_switches&#xFF08;&#x7EBF;&#x7A0B;&#x88AB;&#x52A8;&#x5207;&#x6362;&#xFF09;&#x8FD9;&#x4E24;&#x9879;&#x6709;&#x6CA1;&#x6709;&#x589E;&#x52A0;&#x3002;&#x56E0;&#x6B64;&#x5199;&#x4E86;&#x4E2A;&#x811A;&#x672C;&#x6BCF;&#x9694;1s cat&#x4E00;&#x4E0B;&#x8FD9;&#x4E9B;&#x7EBF;&#x7A0B;&#x7684;&#x72B6;&#x6001;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in {1..3600};do for j in {81994..82001};do date &gt;&gt; istiod_$j.txt; sudo cat /proc/$j/status &gt;&gt; istiod_$j.txt;done;sleep 1s;done</span><br></pre></td></tr></table></figure></pid></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">&#x7EBF;&#x7A0B;&#x72B6;&#x6001;</span><br><span class="line">Thu Feb 16 09:35:10 CST 2017</span><br><span class="line">Name:   istiod0</span><br><span class="line">State:  D (disk sleep)</span><br><span class="line">Tgid:   58434</span><br><span class="line">Pid:    58434</span><br><span class="line">PPid:   2</span><br><span class="line">TracerPid:      0</span><br><span class="line">Uid:    0       0       0       0</span><br><span class="line">Gid:    0       0       0       0</span><br><span class="line">FDSize: 64</span><br><span class="line">Groups:</span><br><span class="line">Threads:        1</span><br><span class="line">SigQ:   1/3099088</span><br><span class="line">SigPnd: 0000000000000000</span><br><span class="line">ShdPnd: 0000000000000000</span><br><span class="line">SigBlk: 0000000000000000</span><br><span class="line">SigIgn: ffffffffffffffff</span><br><span class="line">SigCgt: 0000000000000000</span><br><span class="line">CapInh: 0000000000000000</span><br><span class="line">CapPrm: 0000001fffffffff</span><br><span class="line">CapEff: 0000001fffffffff</span><br><span class="line">CapBnd: 0000001fffffffff</span><br><span class="line">Seccomp:        0</span><br><span class="line">Cpus_allowed:   ffff,ffffffff,ffffffff,ffffffff,ffffffff</span><br><span class="line">Cpus_allowed_list:      0-143</span><br><span class="line">Mems_allowed:   00000000,00000003</span><br><span class="line">Mems_allowed_list:      0-1</span><br><span class="line">voluntary_ctxt_switches:        6172</span><br><span class="line">nonvoluntary_ctxt_switches:     196</span><br><span class="line">**********&#x6301;&#x7EED;10s&#x72B6;&#x6001;&#x548C;switches&#x90FD;&#x6CA1;&#x53D8;&#xFF0C;6172&#x548C;196**********</span><br><span class="line">Thu Feb 16 09:35:20 CST 2017</span><br><span class="line">Name:   istiod0</span><br><span class="line">State:  D (disk sleep)</span><br><span class="line">Tgid:   58434</span><br><span class="line">Pid:    58434</span><br><span class="line">PPid:   2</span><br><span class="line">TracerPid:      0</span><br><span class="line">Uid:    0       0       0       0</span><br><span class="line">Gid:    0       0       0       0</span><br><span class="line">FDSize: 64</span><br><span class="line">Groups:</span><br><span class="line">Threads:        1</span><br><span class="line">SigQ:   1/3099088</span><br><span class="line">SigPnd: 0000000000000000</span><br><span class="line">ShdPnd: 0000000000000000</span><br><span class="line">SigBlk: 0000000000000000</span><br><span class="line">SigIgn: ffffffffffffffff</span><br><span class="line">SigCgt: 0000000000000000</span><br><span class="line">CapInh: 0000000000000000</span><br><span class="line">CapPrm: 0000001fffffffff</span><br><span class="line">CapEff: 0000001fffffffff</span><br><span class="line">CapBnd: 0000001fffffffff</span><br><span class="line">Seccomp:        0</span><br><span class="line">Cpus_allowed:   ffff,ffffffff,ffffffff,ffffffff,ffffffff</span><br><span class="line">Cpus_allowed_list:      0-143</span><br><span class="line">Mems_allowed:   00000000,00000003</span><br><span class="line">Mems_allowed_list:      0-1</span><br><span class="line">voluntary_ctxt_switches:        6173</span><br><span class="line">nonvoluntary_ctxt_switches:     196</span><br><span class="line">************&#x6301;&#x7EED;10s&#x72B6;&#x6001;&#x548C;switches&#x90FD;&#x6CA1;&#x53D8;&#xFF0C;6173&#x548C;196***************</span><br><span class="line">Thu Feb 16 09:35:30 CST 2017</span><br><span class="line">Name:   istiod0</span><br><span class="line">State:  D (disk sleep)</span><br><span class="line">Tgid:   58434</span><br><span class="line">Pid:    58434</span><br><span class="line">PPid:   2</span><br><span class="line">TracerPid:      0</span><br><span class="line">Uid:    0       0       0       0</span><br><span class="line">Gid:    0       0       0       0</span><br><span class="line">FDSize: 64</span><br><span class="line">Groups:</span><br><span class="line">Threads:        1</span><br><span class="line">SigQ:   1/3099088</span><br><span class="line">SigPnd: 0000000000000000</span><br><span class="line">ShdPnd: 0000000000000000</span><br><span class="line">SigBlk: 0000000000000000</span><br><span class="line">SigIgn: ffffffffffffffff</span><br><span class="line">SigCgt: 0000000000000000</span><br><span class="line">CapInh: 0000000000000000</span><br><span class="line">CapPrm: 0000001fffffffff</span><br><span class="line">CapEff: 0000001fffffffff</span><br><span class="line">CapBnd: 0000001fffffffff</span><br><span class="line">Seccomp:        0</span><br><span class="line">Cpus_allowed:   ffff,ffffffff,ffffffff,ffffffff,ffffffff</span><br><span class="line">Cpus_allowed_list:      0-143</span><br><span class="line">Mems_allowed:   00000000,00000003</span><br><span class="line">Mems_allowed_list:      0-1</span><br><span class="line">voluntary_ctxt_switches:        6174</span><br><span class="line">nonvoluntary_ctxt_switches:     196</span><br></pre></td></tr></table></figure>
<p>&#x4ECE;&#x72B6;&#x6001;&#x4E0A;&#x770B;&#xFF0C;&#x786E;&#x5B9E;&#x5F02;&#x5E38;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5BF9;&#x5E94;&#x7684;IO&#x7EBF;&#x7A0B;&#x7684;ctxt_switches&#x90FD;&#x6CA1;&#x6709;&#x53D8;&#x5316;&#xFF0C;&#x5E76;&#x4E14;&#x7EBF;&#x7A0B;&#x72B6;&#x6001;&#x5904;&#x4E8E;D(disk sleep)&#x72B6;&#x6001;&#xFF0C;&#x5904;&#x4E8E;D&#x72B6;&#x6001;&#x7684;&#x5185;&#x6838;&#x7EBF;&#x7A0B;&#x90FD;&#x662F;UNINTERRUPTIBLE&#x7684;&#xFF0C;&#x65E0;&#x6CD5;&#x5524;&#x9192;&#x7684;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x5BF9;&#x6BD4;&#xFF0C;&#x5728;&#x88F8;&#x76D8;&#x6D4B;&#x8BD5;&#x8FC7;&#x7A0B;&#x4E2D;&#x4E5F;&#x6293;&#x53D6;&#x4E86;&#x8FD9;&#x4E9B;IO&#x7EBF;&#x7A0B;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x7ED3;&#x679C;&#x53D1;&#x73B0;&#x8FC7;&#x7A0B;&#x4E2D;&#x6709;&#x4E9B;IO&#x7EBF;&#x7A0B;&#x5904;&#x4E8E;D&#x72B6;&#x6001;&#xFF0C;&#x4F46;&#x662F;&#x8FD8;&#x6709;&#x5904;&#x4E8E;S&#x72B6;&#x6001;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x5524;&#x9192;&#x6765;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x8FDB;&#x4E00;&#x6B65;&#x786E;&#x8BA4;&#x95EE;&#x9898;&#xFF0C;&#x5C06;target&#x7684;IO&#x7EBF;&#x7A0B;&#x6539;&#x6210;1&#x4E2A;&#xFF08;&#x9ED8;&#x8BA4;&#x6BCF;&#x4E2A;target&#x662F;1&#x4E2A;&#x7F51;&#x7EDC;&#x7EBF;&#x7A0B;&#xFF0C;8&#x4E2A;IO&#x7EBF;&#x7A0B;&#xFF09;&#xFF0C;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ietadm --op update --tid=&lt;tid&gt; --params=Wthreads=&lt;N&gt;</span><br></pre></td></tr></table></figure></p>
<p>&#x7136;&#x540E;&#x518D;&#x5206;&#x522B;&#x88F8;&#x76D8;&#x6D4B;&#x8BD5;&#x548C;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E0A;&#x6D4B;&#x8BD5;&#xFF0C;&#x8FD9;&#x6B21;&#x53D1;&#x73B0;&#x88F8;&#x76D8;&#x6D4B;&#x8BD5;&#x65F6;fio&#x4E5F;&#x662F;&#x591A;hang&#x4E86;3&#x6B21;10s&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x5E76;&#x4E14;target&#x7684;&#x90A3;&#x4E2A;IO&#x7EBF;&#x7A0B;&#x662F;&#x5904;&#x4E8E;D&#x72B6;&#x6001;&#x7684;&#x3002;</p>
<p>&#x81F3;&#x6B64;&#xFF0C;&#x57FA;&#x672C;&#x53EF;&#x4EE5;&#x786E;&#x8BA4;&#x662F;&#x7531;&#x4E8E;&#x4ECE;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x6D4B;&#x8BD5;&#x65F6;&#x591A;&#x4F59;&#x7684;sync IO&#x5BFC;&#x81F4;target&#x7684;IO&#x7EBF;&#x7A0B;&#x90FD;D&#x72B6;&#x6001;&#x56E0;&#x6B64;&#x65E0;&#x6CD5;&#x7EE7;&#x7EED;&#x5904;&#x7406;TEST UNIT READY&#x8BF7;&#x6C42;&#x4ECE;&#x800C;&#x5BFC;&#x81F4;initiator&#x7AEF;iscsi&#x8BBE;&#x5907;TUR&#x8BF7;&#x6C42;&#x8D85;&#x65F6;&#x3002;</p>
<p>&#x65E2;&#x7136;&#x662F;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x591A;&#x7684;sync IO&#x5BFC;&#x81F4;&#xFF0C;&#x90A3;&#x4E48;&#x6709;&#x6CA1;&#x6709;&#x53EF;&#x80FD;&#x51CF;&#x5C11;&#x5F02;&#x5E38;&#x60C5;&#x51B5;&#x4E0B;&#x53D1;&#x5230;target&#x7684;IO&#x5462;&#xFF1F;<br>1&#xFF09;&#x4E00;&#x79CD;&#x5C1D;&#x8BD5;&#x662F;&#x8C03;&#x6574;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;flush&#x65F6;&#x95F4;(/proc/sys/vm/dirty_expire_centisecs)&#xFF0C;&#x51CF;&#x5C0F;&#x5237;&#x810F;&#x9875;&#x7684;&#x65F6;&#x95F4;&#x95F4;&#x9694;&#xFF0C;&#x7ED3;&#x679C;&#x6D4B;&#x8BD5;&#x540E;&#x6CA1;&#x6709;&#x6548;&#x679C;&#xFF1B;</p>
<p>2&#xFF09;&#x53E6;&#x5916;&#x4E00;&#x79CD;&#x662F;&#x8C03;&#x6574;&#x8FD9;&#x4E2A;iscsi&#x8BBE;&#x5907;&#x7684;queue_depth(/sys/block/sds/device/queue_depth)&#xFF0C;&#x5BF9;&#x4E8E;iscsi&#x8BBE;&#x5907;&#x9ED8;&#x8BA4;&#x7684;queue_depth=32&#xFF0C;&#x90A3;&#x4E48;&#x53EF;&#x4EE5;&#x5C06;&#x8FD9;&#x4E2A;&#x8C03;&#x5C0F;&#x6BD4;&#x5982;&#x8C03;&#x6574;&#x5230;1&#xFF0C;&#x6D4B;&#x8BD5;&#x786E;&#x8BA4;&#x5F53;&#x8FD9;&#x4E2A;&#x503C;&#x8C03;&#x5C0F;&#x540E;&#xFF0C;target&#x9ED8;&#x8BA4;8&#x4E2A;IO&#x7EBF;&#x7A0B;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4ECE;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x53BB;fio&#x6D4B;&#x8BD5;&#xFF0C;&#x7ED3;&#x679C;&#x6CA1;&#x6709;&#x591A;&#x51FA;30s&#x7684;io hang&#x65F6;&#x95F4;&#x3002;&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;&#x8C03;&#x6574;&#x662F;&#x6709;&#x6548;&#x679C;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x8003;&#x8651;&#x5230;queue_depth&#x8C03;&#x5C0F;&#x540E;&#x4F1A;&#x5F71;&#x54CD;IO&#x6027;&#x80FD;&#xFF08;&#x56E0;&#x4E3A;&#x5F53;io&#x961F;&#x5217;&#x8FBE;&#x5230;&#x8FD9;&#x4E2A;&#x503C;&#x540E;&#x76F4;&#x63A5;&#x5728;&#x8BBE;&#x5907;&#x5C42;&#x9762;&#x5C31;&#x963B;&#x6B62;&#x5C06;&#x540E;&#x7EED;io&#x653E;&#x5165;&#x961F;&#x5217;&#x4E86;&#xFF09;&#xFF0C;&#x56E0;&#x6B64;&#x6362;&#x4E2A;&#x89D2;&#x5EA6;&#x53BB;&#x8C03;&#x5927;&#x540E;&#x7AEF;target&#x7684;IO&#x7EBF;&#x7A0B;&#x3002;</p>
<p>3&#xFF09;&#x90A3;target&#x7684;IO&#x7EBF;&#x7A0B;&#x8C03;&#x6574;&#x5230;&#x591A;&#x5C11;&#x5408;&#x9002;&#x4E86;&#xFF0C;&#x7ECF;&#x8FC7;&#x6D4B;&#x8BD5;&#x8C03;&#x6574;&#x6210;&#x5927;&#x4E8E;queue_depth&#x65F6;&#x6CA1;&#x6709;&#x591A;&#x4F59;&#x7684;30s hang&#xFF0C;&#x4F46;&#x662F;&#x8C03;&#x6574;&#x5230;32&#x6216;&#x8005;30&#xFF0C;&#x6709;&#x7684;&#x65F6;&#x5019;&#x4E0D;&#x4F1A;&#x591A;&#xFF0C;&#x6709;&#x7684;&#x65F6;&#x5019;&#x4E5F;&#x662F;&#x4F1A;&#x591A;30s&#xFF0C;&#x56E0;&#x6B64;&#x4FDD;&#x9669;&#x8D77;&#x89C1;&#xFF0C;&#x8C03;&#x5927;&#x6210;&#x7565;&#x5927;&#x4E8E;queue_depth&#xFF0C;&#x6BD4;&#x5982;&#x8BBE;&#x7F6E;&#x6210;40&#x3002;&#x4E0D;&#x8FC7;&#x6BCF;&#x4E2A;target&#x7684;IO&#x7EBF;&#x7A0B;&#x90FD;&#x6539;&#x6210;40&#x4F1A;&#x5BFC;&#x81F4;&#x5185;&#x6838;&#x8D44;&#x6E90;&#x7684;&#x589E;&#x52A0;&#xFF08;&#x8FD9;&#x70B9;&#x8FD8;&#x80FD;&#x63A5;&#x53D7;&#xFF09;&#xFF0C;&#x53E6;&#x5916;&#x53EF;&#x80FD;&#x4F1A;&#x5F71;&#x54CD;&#x6027;&#x80FD;&#xFF0C;&#x56E0;&#x4E3A;&#x6BCF;&#x4E2A;target&#x7684;IO&#x7EBF;&#x7A0B;&#x662F;&#x5171;&#x7528;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#xFF0C;&#x901A;&#x8FC7;spin_lock&#x6765;&#x83B7;&#x53D6;&#x961F;&#x5217;&#x7684;&#x8BBF;&#x95EE;&#xFF0C;&#x56E0;&#x6B64;&#x6D4B;&#x8BD5;&#x65F6;&#x9700;&#x8981;&#x91CD;&#x70B9;&#x5173;&#x6CE8;&#x6027;&#x80FD;&#x4F1A;&#x4E0D;&#x4F1A;&#x6709;&#x6240;&#x5F71;&#x54CD;&#xFF0C;&#x9501;&#x7684;&#x7ADE;&#x4E89;&#x7684;cpu&#x662F;&#x5426;&#x589E;&#x52A0;&#x7B49;&#x3002;</p>
<h2 id="&#x9644;&#x5F55;"><a href="#&#x9644;&#x5F55;" class="headerlink" title="&#x9644;&#x5F55;"></a>&#x9644;&#x5F55;</h2><h3 id="&#x6392;&#x67E5;&#x95EE;&#x9898;&#x8FC7;&#x7A0B;&#x4E2D;&#x5206;&#x6790;&#x7684;scsi-error-handler&#x90E8;&#x5206;&#x5904;&#x7406;&#x903B;&#x8F91;"><a href="#&#x6392;&#x67E5;&#x95EE;&#x9898;&#x8FC7;&#x7A0B;&#x4E2D;&#x5206;&#x6790;&#x7684;scsi-error-handler&#x90E8;&#x5206;&#x5904;&#x7406;&#x903B;&#x8F91;" class="headerlink" title="&#x6392;&#x67E5;&#x95EE;&#x9898;&#x8FC7;&#x7A0B;&#x4E2D;&#x5206;&#x6790;&#x7684;scsi error handler&#x90E8;&#x5206;&#x5904;&#x7406;&#x903B;&#x8F91;"></a>&#x6392;&#x67E5;&#x95EE;&#x9898;&#x8FC7;&#x7A0B;&#x4E2D;&#x5206;&#x6790;&#x7684;scsi error handler&#x90E8;&#x5206;&#x5904;&#x7406;&#x903B;&#x8F91;</h3><p>&#x8BE6;&#x7EC6;&#x7684;&#x53EF;&#x4EE5;&#x7ED3;&#x5408;<a href="https://lwn.net/Articles/644318/" target="_blank" rel="external">Documentation about scsi_cmnd lifecycle</a>&#x548C;&#x5185;&#x6838;&#x6E90;&#x7801;&#x6765;&#x770B;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">scsi_error_handler()</span><br><span class="line">|</span><br><span class="line">+-&gt;scsi_unjam_host()</span><br><span class="line">   |</span><br><span class="line">   +-&gt;scsi_eh_get_sense()</span><br><span class="line">   |</span><br><span class="line">   +-&gt;scsi_eh_abort_cmds()</span><br><span class="line">   |  |</span><br><span class="line">   |  +-&gt;rtn=scsi_try_to_abort_cmd()</span><br><span class="line">   |  |  |</span><br><span class="line">   |  |  +-&gt;hostt-&gt;eh_abort_handler,iscsi&#x5BF9;&#x5E94;&#x7684;&#x662F;iscsi_eh_abort</span><br><span class="line">   |  +-&gt;if rtn == FAST_IO_FAIL, call scsi_eh_finish_cmd() to put cmd to done_q,</span><br><span class="line">   |  |     else move scmd to check_list</span><br><span class="line">   |  +-&gt;scsi_eh_test_devices()</span><br><span class="line">   |     |</span><br><span class="line">   |     +-&gt;finish_cmds = !scsi_device_online(scmd-&gt;device) ||</span><br><span class="line">   |        (try_stu &amp;&amp; !scsi_eh_try_stu(scmd) &amp;&amp;</span><br><span class="line">   |        !scsi_eh_tur(scmd)) ||</span><br><span class="line">   |        !scsi_eh_tur(scmd);</span><br><span class="line">   |        &#x6211;&#x4EEC;&#x7684;&#x573A;&#x666F;&#x4E0B;try_stu=0,&#x56E0;&#x6B64;&#x8C03;&#x7528;&#x7684;scsi_eh_tur()</span><br><span class="line">   |        |</span><br><span class="line">   |        +-&gt;scsi_send_eh_cmnd(,,SENSE_TIMEOUT)</span><br><span class="line">   |           |</span><br><span class="line">   |           +-&gt;rtn=shost-&gt;hostt-&gt;queuecommand(), here is iscsi_queuecommand()</span><br><span class="line">   |           +-&gt;wait_for_completion_timeout(,,timeout), here wait timeout=SENSE_TIMEOUT=10s</span><br><span class="line">   |           +-&gt;if timeleft==0 &amp;&amp; !rtn, call scsi_abort_eh_cmnd()</span><br><span class="line">   |</span><br><span class="line">   +-&gt;scsi_eh_ready_devs()</span><br><span class="line">   |   (when scsi_eh_abort_cmds() return false then call scsi_eh_ready_devs())</span><br><span class="line">   |  |</span><br><span class="line">   |  +-&gt;scsi_eh_stu()</span><br><span class="line">   |  +-&gt;scsi_eh_bus_device_reset()</span><br><span class="line">   |  |  |</span><br><span class="line">   |  |  +-&gt;scsi_try_bus_device_reset()</span><br><span class="line">   |  |  +-&gt;scsi_eh_tur()</span><br><span class="line">   |  |     |</span><br><span class="line">   |  |     +-&gt;scsi_send_eh_cmnd(,,SENSE_TIMEOUT)</span><br><span class="line">   |  |        |</span><br><span class="line">   |  |        +-&gt;scsi_queuecommand()</span><br><span class="line">   |  |        +-&gt;wait_for_completion_timeout(,,timeout), here wait timeout=SENSE_TIMEOUT=10s</span><br><span class="line">   |  |        +-&gt;scsi_abort_eh_cmnd()</span><br><span class="line">   |  |</span><br><span class="line">   |  +-&gt;scsi_eh_target_reset()</span><br><span class="line">   |  |  |</span><br><span class="line">   |  |  +-&gt;scsi_try_target_reset()</span><br><span class="line">   |  |  +-&gt;scsi_eh_test_devices()</span><br><span class="line">   |  |     |</span><br><span class="line">   |  |     +-&gt;scsi_eh_tur()</span><br><span class="line">   |  |        |</span><br><span class="line">   |  |        +-&gt;scsi_send_eh_cmnd(,,SENSE_TIMEOUT)</span><br><span class="line">   |  |           |</span><br><span class="line">   |  |           +-&gt;scsi_queuecommand()</span><br><span class="line">   |  |           +-&gt;wait_for_completion_timeout(,,timeout), here wait timeout=SENSE_TIMEOUT=10s</span><br><span class="line">   |  |           +-&gt;scsi_abort_eh_cmnd()</span><br><span class="line">   |  +-&gt;scsi_eh_bus_reset()</span><br><span class="line">   |  |  |</span><br><span class="line">   |  |  +-&gt;scsi_try_bus_reset()</span><br><span class="line">   |  |  +-&gt;scsi_eh_test_devices()</span><br><span class="line">   |  |</span><br><span class="line">   |  +-&gt;scsi_eh_host_reset()</span><br><span class="line">   |  |  |</span><br><span class="line">   |  |  +-&gt;scsi_try_host_reset()</span><br><span class="line">   |  |  +-&gt;scsi_eh_test_devices()</span><br><span class="line">   |  |</span><br><span class="line">   |  +-&gt;scsi_eh_offline_sdevs()</span><br><span class="line">   |</span><br><span class="line">   +-&gt;scsi_eh_flush_done_q()</span><br><span class="line">     (For all the EH commands on the done_q, either requeue them to retry(via</span><br><span class="line">      scsi_queue_insert()) if eligible, or finish them up to block layer</span><br><span class="line">      (via scsi_finish_command())</span><br></pre></td></tr></table></figure></p>
<h2 id="systemtap&#x811A;&#x672C;"><a href="#systemtap&#x811A;&#x672C;" class="headerlink" title="systemtap&#x811A;&#x672C;"></a>systemtap&#x811A;&#x672C;</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">%{</span><br><span class="line">#include &lt;linux/types.h&gt;</span><br><span class="line">#include &lt;scsi/scsi_cmnd.h&gt;</span><br><span class="line">#include &lt;scsi/scsi_device.h&gt;</span><br><span class="line">#include &lt;scsi/scsi_host.h&gt;</span><br><span class="line">#include &lt;scsi/scsi_cmnd.h&gt;</span><br><span class="line">#include &lt;linux/timer.h&gt;</span><br><span class="line">#include &lt;linux/blkdev.h&gt;</span><br><span class="line">%}</span><br><span class="line"></span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_send_eh_cmnd&quot;).call {</span><br><span class="line">	host_no = $scmd-&gt;device-&gt;host-&gt;host_no</span><br><span class="line">	channel = $scmd-&gt;device-&gt;channel</span><br><span class="line">	lun = $scmd-&gt;device-&gt;lun</span><br><span class="line">	dev_id = $scmd-&gt;device-&gt;id</span><br><span class="line">	/*print_backtrace()*/</span><br><span class="line">	printf(&quot;%s, scsi_send_eh_cmnd enter: host_no=%d, channel=%d, lun=%d, dev_id=%d, scmd:%p, sense_timeout:%d\n&quot;, ctime(gettimeofday_s()), host_no, channel, lun, dev_id, $scmd, $timeout)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_send_eh_cmnd&quot;).return {</span><br><span class="line">	host_no = $scmd-&gt;device-&gt;host-&gt;host_no</span><br><span class="line">	channel = $scmd-&gt;device-&gt;channel</span><br><span class="line">	lun = $scmd-&gt;device-&gt;lun</span><br><span class="line">	dev_id = $scmd-&gt;device-&gt;id</span><br><span class="line">	printf(&quot;%s, scsi_send_eh_cmnd return: host_no=%d, channel=%d, lun=%d, dev_id=%d, scmd:%p, sense_timeout:%d, return:%d\n\n&quot;, ctime(gettimeofday_s()), host_no, channel, lun, dev_id, $scmd, $timeout, $return)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe module(&quot;libiscsi&quot;).function(&quot;iscsi_queuecommand&quot;).call {</span><br><span class="line">	host_no = $sc-&gt;device-&gt;host-&gt;host_no</span><br><span class="line">	channel = $sc-&gt;device-&gt;channel</span><br><span class="line">	lun = $sc-&gt;device-&gt;lun</span><br><span class="line">	dev_id = $sc-&gt;device-&gt;id</span><br><span class="line">	if (host_no == 62 &amp;&amp; channel == 0 &amp;&amp; lun == 11 &amp;&amp; dev_id == 0) {</span><br><span class="line">		/*print_backtrace()*/</span><br><span class="line">		printf(&quot;%s, iscsi_queuecommand call: host_no=%d, channel=%d, lun=%d, dev_id=%d, scmd:%p\n&quot;, ctime(gettimeofday_s()), host_no, channel, lun, dev_id, $sc)</span><br><span class="line">	}	</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe module(&quot;libiscsi&quot;).function(&quot;iscsi_queuecommand&quot;).return {</span><br><span class="line">	host_no = $sc-&gt;device-&gt;host-&gt;host_no</span><br><span class="line">	channel = $sc-&gt;device-&gt;channel</span><br><span class="line">	lun = $sc-&gt;device-&gt;lun</span><br><span class="line">	dev_id = $sc-&gt;device-&gt;id</span><br><span class="line">	if (host_no == 62 &amp;&amp; channel == 0 &amp;&amp; lun == 11 &amp;&amp; dev_id == 0) {</span><br><span class="line">		printf(&quot;%s, iscsi_queuecommand return: host_no=%d, channel=%d, lun=%d, dev_id=%d, scmd:%p, return=%d\n&quot;, ctime(gettimeofday_s()), host_no, channel, lun, dev_id, $sc, $return)</span><br><span class="line">	}	</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_dispatch_cmd&quot;) {</span><br><span class="line">	host_no = $cmd-&gt;device-&gt;host-&gt;host_no</span><br><span class="line">	channel = $cmd-&gt;device-&gt;channel</span><br><span class="line">	lun = $cmd-&gt;device-&gt;lun</span><br><span class="line">	dev_id = $cmd-&gt;device-&gt;id</span><br><span class="line">	if (host_no == 62 &amp;&amp; channel == 0 &amp;&amp; lun == 11 &amp;&amp; dev_id == 0) {</span><br><span class="line">		printf(&quot;%s, scsi_dispatch_cmd: host_no=%d, channel=%d, lun=%d, dev_id=%d, cmd:%p\n&quot;, ctime(gettimeofday_s()), host_no, channel, lun, dev_id, $cmd)</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_times_out&quot;) {</span><br><span class="line">	printf(&quot;%s, scsi_times_out: scmd:%p\n&quot;, ctime(gettimeofday_s()), $req-&gt;special)	</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe kernel.function(&quot;wait_for_completion_timeout&quot;) {</span><br><span class="line">	printf(&quot;%s, wait_for_completion_timeout\n&quot;, ctime(gettimeofday_s()))</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_eh_test_devices&quot;).call {</span><br><span class="line">	/*print_backtrace()*/</span><br><span class="line">	printf(&quot;%s, scsi_eh_test_devices call: try_stu=%d\n&quot;, ctime(gettimeofday_s()), $try_stu)</span><br><span class="line">}</span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_eh_test_devices&quot;).return {</span><br><span class="line">	printf(&quot;%s, scsi_eh_test_devices return=%d : try_stu=%d\n&quot;, ctime(gettimeofday_s()), $return, $try_stu)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_eh_abort_cmds&quot;) {</span><br><span class="line">	printf(&quot;%s, scsi_eh_abort_cmds\n&quot;, ctime(gettimeofday_s()))</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_eh_bus_device_reset&quot;) {</span><br><span class="line">	printf(&quot;%s, scsi_eh_bus_device_reset\n&quot;, ctime(gettimeofday_s()))</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_eh_target_reset&quot;) {</span><br><span class="line">	printf(&quot;%s, scsi_eh_target_reset\n&quot;, ctime(gettimeofday_s()))</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_eh_host_reset&quot;) {</span><br><span class="line">	printf(&quot;%s, scsi_eh_host_reset\n&quot;, ctime(gettimeofday_s()))</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_eh_bus_reset&quot;) {</span><br><span class="line">	printf(&quot;%s, scsi_eh_bus_reset\n&quot;, ctime(gettimeofday_s()))</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_eh_try_stu&quot;).call {</span><br><span class="line">	printf(&quot;%s, scsi_eh_try_stu call, scmd: %p\n&quot;, ctime(gettimeofday_s()), $scmd)</span><br><span class="line">}</span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_eh_try_stu&quot;).return {</span><br><span class="line">	printf(&quot;%s, scsi_eh_try_stu return, scmd: %p\n&quot;, ctime(gettimeofday_s()), $scmd)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_eh_tur&quot;).call {</span><br><span class="line">	printf(&quot;%s, scsi_eh_tur call, scmd: %p\n&quot;, ctime(gettimeofday_s()), $scmd)</span><br><span class="line">}</span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_eh_tur&quot;).return {</span><br><span class="line">	printf(&quot;%s, scsi_eh_tur return=%d, scmd: %p\n&quot;, ctime(gettimeofday_s()), $return, $scmd)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">probe module(&quot;scsi_mod&quot;).function(&quot;scsi_eh_stu&quot;) {</span><br><span class="line">	printf(&quot;%s, scsi_eh_stu\n&quot;, ctime(gettimeofday_s()))</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6267;&#x884C;&#x811A;&#x672C;&#x7684;&#x547D;&#x4EE4;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo stap -g --all-modules scsi.stp</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    <div>
      
        
      
    </div>

    <div>
      
        
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/kernel/" rel="tag">#kernel</a>
          
            <a href="/tags/scsi/" rel="tag">#scsi</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/03/15/error-disk-cause-iohang/" rel="next" title="坏盘导致IO hang问题分析">
                <i class="fa fa-chevron-left"></i> 坏盘导致IO hang问题分析
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/03/15/iscsiadm-affect-reconnect/" rel="prev" title="频繁执行iscsiadm导致iscsid不进行target的重连">
                频繁执行iscsiadm导致iscsid不进行target的重连 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  <p>热评文章</p>
  <div class="ds-top-threads" data-range="weekly" data-num-items="4"></div>


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/03/15/error-disk-cause-iohang2/"
           data-title="坏盘导致IO hang问题分析（续）" data-url="http://yoursite.com/2017/03/15/error-disk-cause-iohang2/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Wu Dong" />
          <p class="site-author-name" itemprop="name">Wu Dong</p>
          <p class="site-description motion-element" itemprop="description">Diary Notebook</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">31</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#初步分析"><span class="nav-number">1.</span> <span class="nav-text">初步分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多3次10s的分析"><span class="nav-number">2.</span> <span class="nav-text">多3次10s的分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么发送的TUR-TEST-UNIT-READY-命令会超时"><span class="nav-number">3.</span> <span class="nav-text">为什么发送的TUR(TEST UNIT READY)命令会超时</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#网络包分析"><span class="nav-number">3.1.</span> <span class="nav-text">网络包分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iscsitarget端分析"><span class="nav-number">3.2.</span> <span class="nav-text">iscsitarget端分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附录"><span class="nav-number">4.</span> <span class="nav-text">附录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#排查问题过程中分析的scsi-error-handler部分处理逻辑"><span class="nav-number">4.1.</span> <span class="nav-text">排查问题过程中分析的scsi error handler部分处理逻辑</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#systemtap脚本"><span class="nav-number">5.</span> <span class="nav-text">systemtap脚本</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wu Dong</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"sysnote"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
